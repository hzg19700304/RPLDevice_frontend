# 钢轨电位限制柜人机界面需求文档（SRD）

## 1. 文档概述

### 1.1 文档目的

明确钢轨电位限制柜人机界面的功能范围、技术要求、性能指标及交互规则，作为开发、测试、部署的核心依据，确保系统满足 “下位机数据采集 - 工控机中转 - PSCADA 监控 - 系统服务器数据交互” 的全流程需求。

### 1.2 系统定位

本系统是连接**下位机控制板（硬件）**、**工控机（中间层）**、**PSCADA 系统（上层监控）** 及**整个系统的服务器（数据中枢）** 的工业级数据通信与控制平台，支持 “主从嵌套” 通信模式（工控机对下为主站，对上为从站），同时提供本地前端监控界面，实现多层级、全链路的数据流转与指令控制。

### 1.3 目标用户 / 角色

| 角色 / 系统          | 核心诉求                                                     |
| -------------------- | ------------------------------------------------------------ |
| 下位机控制板         | 接收人机界面下发的控制指令，上报传感器数据（模拟量、开关量状态、系统状态、故障信息等） |
| 工控机（人机界面）   | 中转数据（控制板↔PSCADA、控制板↔本地前端、控制板↔系统服务器），实现主从模式切换 |
| PSCADA 系统          | 作为主站，向工控机请求数据、下发控制指令，实现设备实时监控与局部控制 |
| 本地操作员           | 通过前端界面查看实时数据、手动下发控制指令，排查设备状态与通信异常 |
| **整个系统的服务器** | 作为上层数据中枢，接收工控机上传的设备数据（用于全局数据分析、报表生成），下发系统级配置指令（如数据采集频率调整、设备参数阈值更新） |

## 2. 系统架构

### 2.1 物理架构

```plaintext
┌───────────────────┐      ┌──────────────────────────────┐
│ 下位机控制板         │       │ 工控机（中间层）               │
│ （硬件，从站）       │◄────►│ （主站/从站双重角色）            │
└───────────────────┘      └───────────┬──────────────────┘
                                       │
           ┌───────────────────────────┼───────────────────┐
           │                           │                   │
┌──────────▼──────────┐    ┌───────────▼──────────┐    ┌───▼───────────┐
│ PSCADA系统          │     │ 本地前端（NiceUI）     │    │ 本地数据库      │
│ （上层，主站）        │◄───►│ （操作员界面）         │◄───►│ （MySQL）     │
└─────────────────────┘    └──────────────────────┘    └───────────────┘
           │                           │                   │
           └───────────────────────────┼───────────────────┘
                                       │
                              ┌────────▼────────┐
                              │ 系统服务器        │
                              │ （数据中枢）      │
                              └─────────────────┘
```

#### 连接关系详解

1. **下位机控制板 ↔ 工控机**：通过 RS485 串口（COM口以config.ini为准）实现硬件级数据交互，工控机作为主站主动轮询数据，下发控制指令并接收执行确认
2. **工控机 ↔ PSCADA 系统**：采用串口通信（COM口以config.ini为准），工控机为从站，被动响应 PSCADA 的数据请求与控制指令，同步返回执行结果
3. **工控机 ↔ 本地前端**：基于 WebSocket 协议实现实时数据推送与指令下发，端到端延迟≤100ms，支持操作员本地监控
4. **工控机 ↔ 本地数据库**：通过 MySQL 进行数据持久化，存储控制板实时数据与操作日志，存储周期可配置
5. **工控机后端 ↔ 系统总服务器**：支持 TCP/IP 协议，实现常规数据批量上传与系统级指令接收

### 2.2 核心技术栈

| 模块                            | 技术选型                       | 作用说明                                                     |
| ------------------------------- | ------------------------------ | ------------------------------------------------------------ |
| 工控机后端                      | Python + FastAPI               | 提供 WebSocket 服务、串口通信管理、系统服务器交互接口，“实时数据采用 WebSocket” 与 “非实时数据采用 HTTP” |
| 串口通信                        | pyserial（基础串口）+ pymodbus | 实现工控机与控制板、工控机与 PSCADA 的串口数据交互与协议解析<br />可利用pymodbus模块自带的切帧处理 |
| 工控机后端 ↔ 系统总服务器通信   | Python socket（TCP/IP）        | 实现工控机与系统服务器的双向数据传输，支持可靠传输与断线重连 |
| 数据同步策略<br />工控机↔服务器 | 定时批量上传（TCP/IP）         | 常规数据定时批量上传（降低网络开销）                         |
| 本地前端                        | NiceUI                         | 实时数据展示、控制指令下发、设备与通信状态监控<br />代码示例见[NiceGUI Documentation](https://nicegui.io/documentation) |
| 数据存储                        | MySQL                          | 缓存设备历史数据、操作日志（指令执行结果、通信异常记录）<br />使用异步队列（asyncio.Queue）+ 批量插入 |
| 实时通信（前端↔后端）           | FastAPI 原生 WebSocket         | 本地前端与工控机的实时数据推送（无需多连接管理），异步处理   |

## 3. 功能需求

### 3.1 核心功能模块清单

| 模块              | 子功能                            | 优先级     | 需求描述                                                     |
| ----------------- | --------------------------------- | ---------- | ------------------------------------------------------------ |
| 1. 串口通信管理   | 1.1 控制板串口（工控机为主站）    | P0（必须） | 1. 主动轮询控制板数据（间隔可配置，默认 1s，范围 0.1s~1s）；<br />2. 下发控制指令（如 “启动 / 停止”“参数设置”）并接收确认（如 “OK” 响应）；<br />3. 串口断开自动重连（重试间隔 3s），重连成功后自动恢复轮询 |
|                   | 1.2 PSCADA 串口（工控机为从站）   | P0         | 1. 被动监听 PSCADA 指令（如 “请求数据”“控制指令”）；<br />2. 按 PSCADA 格式响应数据（如 “DATA:T:25.5,P:1.2”）；<br />3. 响应超时处理（默认 3s），超时后返回 “ERROR:TIMEOUT” |
| 2. 数据中转       | 2.1 控制板→PSCADA 数据转发        | P0         | 将控制板上报的实时数据（开关量状态、模拟量、设备状态、故障信息）同步转发至 PSCADA，延迟≤100ms |
|                   | 2.2 控制板→本地前端数据推送       | P0         | 通过 WebSocket 向前端推送实时数据，更新频率与控制板轮询间隔一致，支持仪表盘实时展示<br />{<br/>  "push_strategy": {<br/>    "mode": "change_driven",  // 仅推送变化的数据（减少带宽）<br/>    "full_snapshot_interval": 30,  // 每30s推送一次全量快照（防止前端数据丢失）<br/>    "heartbeat_includes_summary": true  // 心跳包附带关键状态摘要<br/>  }<br/>} |
|                   | 2.3 PSCADA→控制板指令转发         | P0         | 接收 PSCADA 控制指令（如 “CONTROL:VALVE_OPEN”），转发至控制板并返回执行结果（成功 / 失败） |
|                   | 2.4 本地前端→控制板指令转发       | P1（重要） | 接收操作员手动指令，转发至控制板，支持指令优先级配置（默认 PSCADA 指令 > 前端指令） |
| 3. 数据存储       | 3.1 实时数据缓存                  | P0         | 将控制板数据存入 MySQL，存储频率可配置，保留 1 年历史数据，支持按设备 ID、时间范围查询 |
|                   | 3.2 操作日志记录                  | P1         | 记录所有指令（PSCADA / 前端 / 系统服务器下发）的执行结果、时间戳、指令内容、指令来源，日志保留≥30 天 |
| 4. 本地前端       | 4.1 实时数据仪表盘                | P0         | 展示开关量状态（输入 / 输出 / 故障信息）、模拟量（电流、电压等）、设备状态（工作 / 测试 / 故障 / 报警） |
|                   | 4.2 控制指令下发                  | P1         | 提供按钮 / 输入框下发常用指令（如 “启动”“停止”“设置参数”），支持指令执行结果弹窗提示 |
|                   | 4.3 连接状态监控                  | P1         | 显示控制板、PSCADA、系统服务器的连接状态（在线 / 离线），断开时显示告警信息与断连时间 |
| 5. 异常处理       | 5.1 串口断开重连                  | P0         | 控制板 / PSCADA 串口断开后，每 3s 重试连接，重连成功后 1s 内恢复数据传输与指令响应 |
|                   | 5.2 数据解析异常处理              | P0         | 若控制板返回数据格式错误（如 “T:abc,P:1.2”），记录日志并跳过该条数据，不影响后续通信 |
|                   | 5.3 指令执行失败重试              | P1         | 控制板未响应指令时，自动重试 1 次（间隔 1s），重试失败后记录日志并向前端 / PSCADA 返回失败原因 |
| 6. 系统服务器交互 | 6.1 数据上传（工控机为从站）      | P0（必须） | 1. **常规数据批量上传**：按配置频率（默认 5s / 次）将控制板实时数据（输入状态、输出状态、系统状态、模拟量、故障信息）批量上传至系统服务器，携带设备唯一标识（如 “DEVICE-001”）；<br />2. **数据完整性保障**：上传数据包含毫秒级时间戳，支持重传机制（服务器未确认接收时，1s 内重试 1 次） |
|                   | 6.2 系统指令接收（工控机为从站）  | P0         | 1. **被动接收指令**：监听系统服务器下发的系统级指令（如 “UPDATE_POLL_INTERVAL:2”“SET_TEMP_THRESHOLD:32”）；<br />2. **指令执行与反馈**：执行指令后 500ms 内返回执行结果（如 “ACK:SUCCESS”），失败时附带原因（如 “ACK:FAIL:INVALID_VALUE”）；<br />3. **指令优先级**：系统服务器指令优先级 > PSCADA 指令 > 本地前端指令 |
|                   | 6.3 断线重连与数据缓存            | P0         | 1. **自动重连**：与系统服务器的 TCP/MQTT 连接断开后，每 5s 重试连接，重连成功后优先同步断连期间的异常记录与未上传常规数据；<br />2. **本地缓存**：断连期间，常规数据按原频率缓存至本地数据库（保留最近 72 小时），异常数据缓存至独立日志文件（最大 100MB，循环覆盖） |
|                   | 6.4 配置同步（系统服务器→工控机） | P1（重要） | 1. **定时拉取配置**：工控机每 30s 向系统服务器请求最新配置（数据上传频率、异常阈值、指令优先级），配置变更时自动更新本地参数；<br />2. **配置备份**：更新前备份当前配置，新配置生效失败时自动回滚并上报服务器 |
| 7. 指令调度管理   | 7.1 指令队列与优先级              | P0         | 1. 所有指令进入统一队列，按优先级排序（服务器=10，PSCADA=5，前端=1） <br />2. 高优先级指令可打断低优先级指令执行 <br />3. 同优先级指令按时间戳FIFO执行 <br />4. 冲突指令（如同时"开启"和"关闭"）需拒绝后到达的指令，返回"CONFLICT"错误 |

### 3.2 主从模式交互规则

| 交互方向          | 角色定位         | 通信协议（示例）                                             |
| ----------------- | ---------------- | ------------------------------------------------------------ |
| 工控机→控制板     | 工控机为主站     | 1. 数据请求：`READ_DATA\n`（工控机发送）；<br />2. 数据响应：`T:25.5,P:1.2,STATUS:ON\n`（控制板返回）；<br />3. 指令下发：`VALVE_OPEN\n`（工控机发送）；<br />4. 指令确认：`OK\n`（控制板返回） |
| PSCADA→工控机     | PSCADA 为主站    | 1. 数据请求：`GET_DATA\n`（PSCADA 发送）；<br />2. 数据响应：`DATA:T:25.5,P:1.2\n`（工控机返回）；<br />3. 指令下发：`CONTROL:VALVE_CLOSE\n`（PSCADA 发送）；<br />4. 指令响应：`CONTROL_ACK:True\n`（工控机返回） |
| 系统服务器→工控机 | 系统服务器为主站 | 1. 数据请求：`GET_HISTORY:DEVICE-001,20240521-1000,20240521-1200\n`（服务器发送）；<br />2. 数据响应：`HISTORY_DATA:[{"timestamp":"...","temp":25.5},...]\n`（工控机返回）；<br />3. 配置指令：`SET_POLL:5\n`（服务器发送）；<br />4. 指令响应：`ACK:SET_POLL:SUCCESS\n`（工控机返回） |

## 4. 非功能需求

### 4.1 性能需求

| 指标                   | 要求                                                         |
| ---------------------- | ------------------------------------------------------------ |
| 数据传输延迟           | 1. 控制板→工控机→前端 / PSCADA 延迟≤100ms；<br />2. 控制板→工控机→系统服务器（常规数据）延迟≤500ms，异常数据延迟≤100ms |
| 轮询频率               | 工控机对控制板的轮询间隔可配置（默认 0.5s，范围 0.3s~10s）     |
| 系统指令响应时间       | 接收系统服务器 / PSCADA / 前端指令到返回执行结果的时间≤500ms |
| 并发连接兼容性         | 工控机同时与系统服务器、PSCADA、本地前端通信时，CPU 使用率≤60%，内存占用≤40%（基于 4GB 内存配置） |
| 数据存储性能           | MySQL 单条数据写入耗时≤50ms，支持每秒 10 条数据写入（峰值）  |
| 断连数据缓存能力       | 本地数据库支持缓存 72 小时常规数据（按 5s / 条计算，约 10 万条）；异常日志文件支持循环覆盖（最大 100MB）<br />采用按月分区 + 自动清理 |
| 系统服务器并发接收能力 | 系统服务器支持同时接收至少 100 台工控机的并发数据上传（每台 5s / 次，单条数据 100B 以内） |

### 4.2 可靠性需求

| 指标                 | 要求                                                         |
| -------------------- | ------------------------------------------------------------ |
| 串口重连成功率       | 控制板 / PSCADA 恢复连接后，工控机重连成功率≥99%（重试 3 次内） |
| 系统服务器重连成功率 | 网络恢复后，工控机与系统服务器的重连成功率≥99.5%（重试 5 次内） |
| 数据丢失率           | 正常通信情况下，控制板数据丢失率≤0.1%（重连导致的临时丢失可忽略） |
| 断连数据补传完整性   | 重连后，断连期间的异常数据 100% 补传，常规数据补传成功率≥99.9%（丢失数据可通过本地日志人工补传） |
| 系统稳定性           | 7×24 小时连续运行，无内存泄漏、死锁，平均无故障时间（MTBF）≥1000 小时 |
| 指令执行一致性       | 系统服务器 / PSCADA 下发的配置指令，在工控机与前端 / PSCADA 间的同步延迟≤1s，避免数据展示不一致 |
| 日志完整性           | 所有关键操作（指令下发、串口断开、数据异常、重连事件）需记录日志，日志保留≥30 天 |

### 4.3 安全性需求

| 需求         | 要求                                                         |
| ------------ | ------------------------------------------------------------ |
| 指令优先级   | 支持配置指令优先级（默认：系统服务器指令 > PSCADA 指令 > 本地前端指令），避免多上层系统指令冲突 |
| 数据校验     | 1. 对控制板返回数据进行格式与范围校验（如温度 -40℃~120℃），异常数据不转发；<br />2. 系统服务器上传数据附带签名（可选），防止数据篡改 |
| 本地访问控制 | 前端界面支持简单密码认证（可选），避免未授权操作；支持操作日志与操作员绑定，便于追溯 |
| 网络安全     | 工控机与系统服务器通信（尤其是广域网场景）需配置 VPN 或 SSL/TLS 加密通道，保障数据不泄露、不被篡改 |

### 4.4 兼容性需求

| 兼容对象           | 要求                                                         |
| ------------------ | ------------------------------------------------------------ |
| 串口参数           | 支持波特率配置（9600/19200/38400bps）、数据位（8 位）、停止位（1 位）、校验位（无 / 奇 / 偶） |
| 系统服务器通信协议 | 支持 TCP/IP（默认，端口可配置，如 8080）                     |
| 数据格式           | 上传数据与接收指令支持 JSON 格式                             |