# 钢轨电位限制柜人机界面UI需求文档

## 1. 文档概述

### 1.1 文档目的

明确钢轨电位限制柜人机界面的UI设计规范、页面功能、交互逻辑及实现要求,为前端开发提供完整的设计依据。

### 1.2 技术选型

- **前端框架**: NiceUI (Python-based UI framework)
- **实时通信**: FastAPI WebSocket
- **数据可视化**: 支持折线图、仪表盘、状态指示器
- **交互方式**: 鼠标点击、虚拟键盘输入

### 1.3 界面配置

根据`config.ini`中`[界面标签配置]`节控制页面显示:

```ini
show_main_diagram = true          # 主接线图
show_system_status = true         # 系统状态
show_event_record = true          # 事件记录
show_real_time_curve = true       # 实时曲线
show_history_curve = true         # 历史曲线
show_parameter_settings = true    # 参数设置
show_api_status = true            # API状态
show_fault_record = true          # 故障录波
show_range_settings = false       # 量程设置(隐藏)
show_channel_calibration = false  # 通道校正(隐藏)
```

**注意**:

- 当配置项为`true`时,对应页面在左侧导航栏显示
- 当配置项为`false`时,对应页面隐藏但功能保留(可通过其他入口访问)
- 系统设置功能通过顶部菜单栏访问,不受此配置控制

------

## 2. 整体布局

### 2.1 主界面结构

```
┌─────────────────────────────────────────────────────────┐
│  顶部栏: 设备名称 | 系统时间 | 连接状态 | [设置▼] | 用户  │
├─────────────────────────────────────────────────────────┤
│ 左侧导航栏           │  主内容区域                       │
│ ├─ 主接线图          │                                  │
│ ├─ 系统状态          │  (根据左侧菜单切换页面内容)       │
│ ├─ 事件记录          │                                  │
│ ├─ 实时曲线          │                                  │
│ ├─ 历史曲线          │                                  │
│ ├─ 参数设置          │                                  │
│ ├─ API状态           │                                  │
│ ├─ 故障录波          │                                  │
│ [├─ 量程设置]        │  (默认隐藏,由配置控制)            │
│ [└─ 通道校正]        │  (默认隐藏,由配置控制)            │
├─────────────────────────────────────────────────────────┤
│  底部状态栏: 控制板连接 | PSCADA连接 | 服务器连接       │
└─────────────────────────────────────────────────────────┘
```

**说明**: 左侧导航栏的菜单项根据`config.ini`的`[界面标签配置]`动态生成

### 2.2 顶部栏设计

| 元素           | 内容                            | 更新方式          |
| -------------- | ------------------------------- | ----------------- |
| 设备名称       | 显示`config.ini`中的`设备名称`  | 静态              |
| 系统时间       | 格式:`YYYY-MM-DD HH:MM:SS`      | 每秒更新          |
| 连接状态指示器 | 三个圆点:控制板/PSCADA/服务器   | WebSocket实时更新 |
| 设置菜单       | 下拉菜单:串口设置/采集设置/关于 | 点击展开          |
| 用户信息       | 用户名 + 权限类型 + 登出按钮    | 登录后显示        |

**连接状态指示器**:

- 🟢 绿色: 在线正常
- 🔴 红色: 离线/异常
- 🟡 黄色: 连接中/重连中

**设置下拉菜单**:

```
[设置▼]
├─ 串口配置
│  ├─ HMI串口设置
│  └─ PSCADA串口设置
├─ 采集设置
│  ├─ 轮询间隔
│  ├─ 上传频率
│  └─ 保存周期
└─ 关于
   ├─ 系统信息
   └─ 版本信息
```

### 2.3 底部状态栏

显示详细连接信息:

```
控制板: ✓ COM1 (9600bps) | PSCADA: ✓ COM2 (9600bps) | 服务器: ✓ 192.168.0.1:8000 | 最后更新: 2025-10-01 10:30:25
```

------

## 3. 页面详细设计

### 3.1 主接线图页面

#### 3.1.1 功能说明

- 实时显示设备主接线图及运行状态
- 根据WebSocket推送的实时数据动态更新控件状态
- 界面底图见限制柜一次回路图.svg

#### 3.1.2 控件状态映射

| 控件            | 数据源                  | 正常状态                                                     | 异常状态      |
| --------------- | ----------------------- | ------------------------------------------------------------ | ------------- |
| SA1(支路1电流)  | `analog_data.支路1电流` | 显示数值+单位                                                | 红色边框+数值 |
| SA2(支路2电流)  | `analog_data.支路2电流` | 显示数值+单位                                                | 红色边框+数值 |
| SV1(支路电压1)  | `analog_data.支路电压1` | 显示数值+单位                                                | 红色边框+数值 |
| SV2(支路电压2)  | `analog_data.支路电压2` | 显示数值+单位                                                | 红色边框+数值 |
| KM1(短接接触器) | `switch_input.bit0`     | bit0=1:合位(红色背景+直线连接)<br>bit0=0:分位(绿色背景+斜线)![image-20250929131320295](C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20250929131320295.png) | -             |

#### 3.1.4 数据更新逻辑

```python
# WebSocket接收到analog_data消息时
def on_analog_data(data):
    for item in data['data']:
        if item['name'] == '支路1电流':
            update_widget('SA1', item['physical_value'], item['unit'])
        # ... 其他通道
```

------

### 3.2 系统状态页面

#### 3.2.1 功能说明

- 显示系统状态字、开关量输入/输出、故障信息的位状态
- 使用分组展示,每个分组对应config.ini中的配置节

#### 3.2.2 分组设计

| 分组名称   | 配置节                | 显示逻辑               |
| ---------- | --------------------- | ---------------------- |
| 系统状态   | `[HMI系统状态点表]`   | 16个状态位(bit0-bit15) |
| 开关量输入 | `[HMI开关量输入点表]` | 16个状态位             |
| 开关量输出 | `[HMI开关量输出点表]` | 16个状态位             |
| 故障信息   | `[HMI故障点表]`       | 16个状态位             |

#### 3.2.3 状态指示器颜色规则

```python
def get_indicator_color(bit_value, status_name):
    if status_name == "保留":
        return "gray"  # 灰色圆点
    elif bit_value == 1:
        return "red"   # 红色圆点(故障/合位/合闸)
    else:
        return "green" # 绿色圆点(正常/分位/分闸)
```

#### 3.2.4 布局示例

```
┌─ 系统状态 ──────────────────────────┐
│ bit0: ⚪ 保留                       │
│ bit1: ⚪ 保留                       │
│ bit5: 🔴 故障状态                    │
│ bit7: 🟢 参数正确                   │
│ bit8: 🟢 KM1恢复                    │
│ ...                                │
└────────────────────────────────────┘
```

#### 3.2.5 配置文件解析

从`config.ini`读取状态名称:

```python
# 示例: [HMI系统状态点表]下的配置
# bit5 = 故障恢复,故障状态
status_config = config['HMI系统状态点表']['bit5'].split(',')
label_0 = status_config[0]  # "故障恢复"
label_1 = status_config[1]  # "故障状态"
```

------

### 3.3 事件记录查询页面

#### 3.3.1 功能说明

- 查询并展示数据库中的`event_records`表数据
- 支持按日期范围、事件类型筛选
- 分页显示查询结果

#### 3.3.2 查询条件

| 字段     | 类型       | 说明                                     |
| -------- | ---------- | ---------------------------------------- |
| 开始日期 | DatePicker | 默认当天00:00:00                         |
| 结束日期 | DatePicker | 默认当前时间                             |
| 事件类型 | Dropdown   | 全部/系统启动/通信异常/故障触发/用户操作 |

#### 3.3.3 表格列设计

| 列名     | 字段          | 宽度  | 格式                    |
| -------- | ------------- | ----- | ----------------------- |
| 序号     | -             | 60px  | 自动编号                |
| 事件时间 | `event_time`  | 180px | YYYY-MM-DD HH:MM:SS.sss |
| 事件类型 | `event_type`  | 120px | 文本                    |
| 事件描述 | `description` | 400px | 文本,支持换行           |
| 设备ID   | `device_id`   | 150px | 文本                    |

#### 3.3.4 查询按钮逻辑

```python
async def on_query_click():    
    # 1. 调用API接口
    response = await api_client.get(
        f"/api/v1/history/events",
        params={
            "start_time": start_date.strftime("%Y-%m-%d %H:%M:%S"),
            "end_time": end_date.strftime("%Y-%m-%d %H:%M:%S"),
            "event_type": selected_event_type
        }
    )
    
    # 2. 更新表格数据
    update_table(response['data']['list'])
```

------

### 3.4 实时曲线页面

#### 3.4.1 功能说明

- 实时显示模拟量变化趋势
- 固定时间窗口(2分钟)滚动显示
- 支持多曲线叠加显示
- 实时刷新,数据更新间隔1秒
- 数据从websocket实时接收

#### 3.4.2 曲线配置

| 曲线名称     | 数据源                     | 颜色    | Y轴单位 | 默认显示 |
| ------------ | -------------------------- | ------- | ------- | -------- |
| 最大极化电位 | `analog_data.最大极化电位` | #FF5733 | V       | ✓        |
| 支路1电流    | `analog_data.支路1电流`    | #3498DB | A       | ✓        |
| 支路2电流    | `analog_data.支路2电流`    | #2ECC71 | A       | ✓        |
| 支路电压1    | `analog_data.支路电压1`    | #F39C12 | V       | ✗        |
| 支路电压2    | `analog_data.支路电压2`    | #9B59B6 | V       | ✗        |

具体需根据config.ini中的[HMI模拟量输入点表]配置项来添加曲线，以上为示例

#### 3.4.3 X轴设计

- 时间窗口: 120秒(2分钟)
- 刻度间隔: 10秒
- 格式: `HH:MM:SS`
- 滚动方式: 新数据从右侧进入,旧数据从左侧移出

#### 3.4.4 曲线选择器

```
┌─ 曲线选择 ─────────────────────┐
│ ☑ 最大极化电位 (红色)           │
│ ☑ 支路1电流 (蓝色)              │
│ ☑ 支路2电流 (绿色)              │
│ ☐ 支路电压1 (橙色)              │
│ ☐ 支路电压2 (紫色)              │
└────────────────────────────────┘
```
具体需根据config.ini中的[HMI模拟量输入点表]配置项来添加曲线选择器中的选项，以上为示例
#### 3.4.5 数据缓存策略

```python
# 使用环形缓冲区存储最近120个数据点
from collections import deque

curve_buffer = {
    '最大极化电位': deque(maxlen=120),
    '支路1电流': deque(maxlen=120),
    # ...
}

def on_analog_data(data):
    for item in data['data']:
        if item['name'] in curve_buffer:
            curve_buffer[item['name']].append({
                'timestamp': data['timestamp'],
                'value': item['physical_value']
            })
    update_chart()
```

------

### 3.5 历史曲线查询页面

#### 3.5.1 功能说明
- 查询并展示历史模拟量数据（通过API接口，从后端数据库中按查询条件获取）
- 支持曲线缩放、拖拽、数值交叉点
- 曲线名称根据config.ini中的[HMI模拟量输入点表]配置项来显示
- 用户能选择需要显示的具体曲线，默认显示所有曲线

#### 3.5.2 查询面板

```
┌─ 查询条件 ─────────────────────────────────────┐
│ 开始时间: [2025-10-01 00:00:00]  ▼             │
│ 结束时间: [2025-10-01 23:59:59]  ▼             │
│ 查询日期：[2025-10-01]                          │
│ 参数选择: ☑最大极化电位 ☑支路1电流 ☐支路2电流      │
│ [开始查询]  [导出CSV]                           │
└───────────────────────────────────────────────┘
```

#### 3.5.3 图表交互

| 操作           | 功能                                 |
| --------------| ------------------------------------ |
| 鼠标滚轮       | 上下滚动:Y轴缩放; Shift+滚轮:X轴缩放     |
| 右键拖拽       | 平移视图                               |
| 左键点击数据点 | 显示详细数值和时间戳                      |
| 双击图表       | 恢复默认视图                            |

#### 3.5.4 数据导出

点击"导出CSV"按钮时:

```python
async def export_to_csv():
    # 1. 生成CSV文件
    csv_content = "时间,参数名称,数值,单位\n"
    for record in query_results:
        csv_content += f"{record['timestamp']},{record['parameter_name']},{record['value']},{record['unit']}\n"
    
    # 2. 触发浏览器下载
    download_file(csv_content, f"历史数据_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv")
```

------

### 3.6 控制参数设置页面

#### 3.6.1 功能说明

- 从config.ini文件读取/写入HMI控制参数寄存器(0x2200-0x221A)
- 参数验证与范围限制
- 操作日志记录
- 参数值从websocket实时接收并更新到前端
- 参数写入时，先验证数值是否在有效范围内，再通过websocket发送写入请求

#### 3.6.2 参数列表

根据`config.ini`的`[HMI系统控制参数地址映射]`生成:

| 寄存器地址 | 参数名称    | 值范围  | 单位 | 默认值 |
| ---------- | ----------- | ------- | ---- | ------ |
| 0x2200     | 1段保护值   | 0-500   | V    | 300    |
| 0x2201     | 2段保护值   | 0-500   | V    | 350    |
| ...        | ...         | ...     | ...  | ...    |
| 0x220A     | 1段保护延时 | 0-10000 | ms   | 500    |
| 0x221A     | 保留3       | -       | -    | 0      |

#### 3.6.3 操作流程

```
1. 用户点击[读取]按钮
   ↓
2. WebSocket发送param_read请求(read_type=control_params)
   ↓
3. 后端通过串口0x03命令读取0x2200-0x221A寄存器
   ↓
4. WebSocket推送param_read_ack消息
   ↓
5. 前端更新所有输入框的值

------------------------------------

6. 用户点击输入框 → 弹出虚拟数字键盘
   ↓
7. 用户输入新值并确认
   ↓
8. 验证数值是否在有效范围内
   ↓
9. 用户点击[写入]按钮
   ↓
10. WebSocket发送control_cmd(cmd=set_param)
   ↓
11. 后端通过串口0x10命令写入寄存器
   ↓
12. WebSocket推送control_ack消息
   ↓
13. 显示成功/失败提示
```

#### 3.6.4 输入验证

```python
def validate_param_value(param_name, value):
    param_ranges = {
        '1段保护值': (0, 500),
        '1段保护延时': (0, 10000),
        # ...
    }
    
    if param_name not in param_ranges:
        return True, ""
    
    min_val, max_val = param_ranges[param_name]
    if not (min_val <= value <= max_val):
        return False, f"值必须在{min_val}-{max_val}之间"
    
    return True, ""
```

------

### 3.7 故障录波查询页面

#### 3.7.1 功能说明

- 查询故障录波目录(0x0300-0x0303寄存器)
- 读取完整故障录波详情(串口0x14命令)
- 展示故障波形数据表格

#### 3.7.2 顶部控制面板

```
┌─ 故障录波查询 ──────────────────────────────────┐
│ 记录可读数: [15]                                │
│ 记录编号: [0▼] (0=最新记录)                      │
│ [查询目录]  [查询详情]  [取消]  [清除记录]         │
└───────────────────────────────────────────────┘
```

#### 3.7.3 故障信息显示

```
故障发生时间: 2025-10-01 13:45:12.345
故障码: [0x0001] ← 点击弹出解析对话框
故障描述: 1段电压保护
```

#### 3.7.4 数据表格

| 列名         | 宽度  | 说明                      |
| ------------ | ----- | ----------------------- |
| 点序号       | 60px  | 0-299                    |
| 系统状态     | 100px | 0xXXXX,点击弹出解析对话框   |
| 开关量输入   | 100px | 0xXXXX,点击弹出解析对话框    |
| 开关量输出   | 100px | 0xXXXX,点击弹出解析对话框    |
| 轨电位最大值 | 100px | 数值+单位                  |
| 最大极化电位 | 100px | 数值+单位                  |
| 支路1电流    | 80px  | 数值+单位                  |
| 支路2电流    | 80px  | 数值+单位                  |
| ...          | ...   | 其他通道                  |
数据表格中模拟量名称根据config.ini中的[HMI系统模拟量地址映射]生成

#### 3.7.5 查询进度显示

查询过程中显示进度条:

```
┌─ 正在读取故障录波... ────────────┐
│ ████████████░░░░░░░░ 60%        │
│ 当前批次: 19/32                 │
│ 预计剩余时间: 8秒                │
│ [取消查询]                       │
└──────────────────────────────────┘
```

#### 3.7.6 点位数据解析对话框

点击"故障码"、"系统状态"、"开关量输入"、"开关量输出"时弹出:

```
┌─ 数据解析(0x0104) ─────────┐
│ bit0: 🟢 工作状态          │
│ bit1: 🔴 正在吸收          │
│ bit2: 🟢 正常              │
│ bit5: 🔴 故障状态          │
│ ...                       │
│ [关闭]                     │
└───────────────────────────┘
```
点位信息根据config.ini中的[HMI系统状态点表]、[HMI开关量输入点表]、[HMI开关量输出点表]生成
#### 3.7.7 故障录波读取错误对话框

当读取失败时显示:

```
┌─ 读取失败 ───────────────────────────────────┐
│ ❌ 读取故障录波数据失败                     │
│                                           │
│ 错误信息: 串口通信超时：第10批数据读取失败  │
│ 失败批次: 10/32                            │
│                                           │
│ [重试]  [取消]                              │
└─────────────────────────────────────────────┘
```

#### 3.7.8 清除记录确认对话框

点击[清除记录]按钮时显示:

```
┌─ 确认清除 ───────────────────────────────────┐
│ ⚠️  警告：此操作将清除所有故障录波记录           │
│                                             │
│ 是否确认清除所有记录？                          │
│                                             │
│ [确认]  [取消]                                │
└─────────────────────────────────────────────┘
```
#### 3.7.9 操作流程

##### (1) 查询故障录波目录

```
1. 用户点击[查询目录]按钮
   ↓
2. WebSocket发送param_read请求(read_type=recording_dir)
   ↓
3. 后端通过串口0x03命令读取0x0300-0x0303寄存器
   ↓
4. WebSocket推送param_read_ack消息
   ↓
5. 前端更新记录可读数
```

##### (2) 读取故障录波详情

```
6. 用户选择需要读取的记录编号，点击[读取故障录波]按钮
   ↓
7. WebSocket发送fault_record_read请求
    {
      "type": "fault_record_read",
      "device_id": "HYP_RPLD_001",
      "record_id": 0,           // 0=最新记录，1=第一条，依此类推
      "request_id": "req_fault_read_001"
    }
   ↓
8. 后端返回fault_record_read_start确认消息
    {
      "type": "fault_record_read_start",
      "total_registers": 3907,
      "batch_size": 125,        // 每批读取125个寄存器
      "total_batches": 32,      // 共需32批
      "estimated_time": 15,     // 预计耗时(秒)
      "percentage": 0
    }
   ↓
9. 前端显示进度条对话框(0%)，显示"正在读取故障录波数据..."
   ↓
10. 后端通过串口0x14命令开始分批读取故障录波数据
   ↓
11. WebSocket推送fault_record_progress进度消息
    {
      "type": "fault_record_progress",
      "current_batch": 5,
      "total_batches": 32,
      "percentage": 15.6
    }
   ↓
12. 前端更新进度条显示(15.6%)，显示当前批次和总批次信息
   ↓
13. 重复步骤10-12，直到所有32批次读取完成
   ↓
14. WebSocket推送fault_record_complete完成消息
    {
      "type": "fault_record_complete",
      "data": {
        "fault_info": {
          "fault_time": "2024-09-29 13:45:12.345",
          "fault_bits": "0x0001",
          "fault_point": 150,
          "record_cycle": 100
        },
        "data_points": [
          {
            "point_index": 0,
            "system_status": "0x0104",
            "switch_input": "0x0200",
            "switch_output": "0x0101",
            "rail_potential_max": 255,
            "max_polarization": -120,
            "branch_currents": [12, 13, 11, 10, 9, 8],
            "branch_voltages": [24, 25]
          }
          // ... 共300个数据点
        ]
      }
    }
   ↓
15. 前端关闭进度条对话框
   ↓
16. 前端展示故障波形数据表格和图表，包含完整的300个数据点
```

##### (4) 读取失败处理

```
// 如果在读取过程中发生错误
15. WebSocket推送fault_record_error错误消息
    {
      "type": "fault_record_error",
      "error_code": 500,
      "error_msg": "串口通信超时：第10批数据读取失败",
      "current_batch": 10
    }
   ↓
16. 前端显示错误提示对话框
   ↓
17. 用户可选择[重试]或[取消]
```

##### (5) 取消读取操作

```
// 用户在读取过程中点击[取消]按钮
15. WebSocket发送fault_record_cancel请求
    {
      "type": "fault_record_cancel",
      "device_id": "HYP_RPLD_001",
      "request_id": "req_fault_read_001"
    }
   ↓
16. 后端返回fault_record_cancelled确认
    {
      "type": "fault_record_cancelled",
      "cancelled_at_batch": 10
    }
   ↓
17. 前端关闭进度条对话框
```

##### (6) 清除故障录波记录

```
// 用户点击[清除记录]按钮
1. 前端显示确认对话框
   ↓
2. 用户确认后，WebSocket发送control_cmd请求
    {
      "type": "control_cmd",
      "cmd": "fault_record_clear",
      "cmd_param": {
        "coil_addr": "0x0110",
        "confirm": true
      }
    }
   ↓
3. 后端通过串口写入线圈0x0110
   ↓
4. WebSocket推送control_ack响应
    {
      "type": "control_ack",
      "cmd": "fault_record_clear",
      "exec_status": "success",
      "exec_msg": "故障录波记录已清除",
      "cleared_count": 15
    }
   ↓
5. 前端显示成功提示并刷新记录列表
```

------

### 3.8 API状态监控页面

#### 3.8.1 功能说明

- 监控工控机与服务器的通信状态
- 显示数据上传统计
- 查看未上传数据队列

#### 3.8.2 连接状态面板

```
┌─ 服务器连接状态 ────────────────────────────┐
│ 服务器地址: 192.168.0.1:8000                │
│ 连接状态: 🟢 在线                           │
│ 最后通信时间: 2025-10-01 14:30:25          │
│ 重连次数: 0                                 │
│ 网络延迟: 45ms                              │
└────────────────────────────────────────────┘
```

#### 3.8.3 数据上传统计

| 数据类型 | 待上传 | 已上传 | 失败 | 重试次数 |
| -------- | ------ | ------ | ---- | -------- |
| 状态历史 | 125    | 1,523  | 3    | 5        |
| 实时数据 | 458    | 12,456 | 0    | 0        |
| 事件记录 | 2      | 89     | 0    | 0        |

#### 3.8.4 操作按钮

- **手动触发上传**: 立即上传所有待上传数据
- **查看失败记录**: 显示上传失败的详细信息
- **清空统计**: 重置统计计数器

#### 3.8.5 失败记录详情

点击"查看失败记录"时显示:

```
┌─ 上传失败记录 ──────────────────────────────┐
│ 时间: 2025-10-01 14:25:30                  │
│ 数据类型: status_history                   │
│ 记录ID: 12345                              │
│ 失败原因: 服务器响应超时                    │
│ [重试]  [删除]                              │
└────────────────────────────────────────────┘
```

------

### 3.9 量程设置页面

#### 3.9.1 功能说明

- 读取/写入传感器参数寄存器(0x2000-0x200F)
- 设置AI通道的上限和下限值
- 对应`show_range_settings`配置项(默认隐藏)

#### 3.9.2 参数列表

根据`config.ini`的`[HMI传感器参数寄存器]`配置:

| 寄存器地址 | 参数名称 | 值范围       | 单位 | 说明            |
| ---------- | -------- | ------------ | ---- | --------------- |
| 0x2000     | AI1下限  | -32768~32767 | -    | 模拟量通道1下限 |
| 0x2001     | AI2下限  | -32768~32767 | -    | 模拟量通道2下限 |
| ...        | ...      | ...          | ...  | ...             |
| 0x2007     | AI8下限  | -32768~32767 | -    | 模拟量通道8下限 |
| 0x2008     | AI1上限  | -32768~32767 | -    | 模拟量通道1上限 |
| ...        | ...      | ...          | ...  | ...             |
| 0x200F     | AI8上限  | -32768~32767 | -    | 模拟量通道8上限 |

#### 3.9.3 界面布局

```
┌─ 模拟量通道量程设置 ────────────────────────────┐
│ [读取]  [写入]                                  │
├─────────────────────────────────────────────────┤
│ 通道  │ 下限值        │ 上限值        │ 状态   │
├───────┼───────────────┼───────────────┼────────┤
│ AI1   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI2   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI3   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI4   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI5   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI6   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI7   │ [-1000]       │ [1000]        │ ✓正常  │
│ AI8   │ [-1000]       │ [1000]        │ ✓正常  │
└─────────────────────────────────────────────────┘
```

#### 3.9.4 操作流程

```
1. 用户点击[读取]按钮
   ↓
2. WebSocket发送param_read请求(read_type=sensor_params)
   ↓
3. 后端通过串口0x03命令读取0x2000-0x200F寄存器
   ↓
4. WebSocket推送param_read_ack消息
   ↓
5. 前端更新所有输入框的值

------------------------------------

6. 用户点击输入框 → 弹出虚拟数字键盘
   ↓
7. 用户输入新值并确认
   ↓
8. 验证下限值 < 上限值
   ↓
9. 用户点击[写入]按钮
   ↓
10. WebSocket发送control_cmd(cmd=set_sensor_params)
   ↓
11. 后端通过串口0x10命令写入寄存器
   ↓
12. WebSocket推送control_ack消息
   ↓
13. 显示成功/失败提示并更新状态列
```

#### 3.9.5 输入验证

```python
def validate_sensor_range(channel, lower, upper):
    """验证传感器量程设置"""
    # 1. 检查范围
    if not (-32768 <= lower <= 32767):
        return False, f"AI{channel}下限值超出范围(-32768~32767)"
    
    if not (-32768 <= upper <= 32767):
        return False, f"AI{channel}上限值超出范围(-32768~32767)"
    
    # 2. 检查逻辑
    if lower >= upper:
        return False, f"AI{channel}下限值必须小于上限值"
    
    return True, ""
```

------

### 3.10 通道校正页面

#### 3.10.1 功能说明

- 读取/写入AI校正值寄存器(0x2100-0x2117)
- 三点校正:下限/上限/中点
- 对应`show_channel_calibration`配置项(默认隐藏)

#### 3.10.2 校正原理

每个AI通道包含3个校正点:

- **下限校正**(0x2100-0x2107): 对应传感器最小输出值
- **上限校正**(0x2108-0x210F): 对应传感器最大输出值
- **中点校正**(0x2110-0x2117): 对应传感器中间值(零点)

#### 3.10.3 界面布局

```
┌─ 模拟量通道校正 ────────────────────────────────┐
│ [读取]  [写入]  [开始校正向导]                  │
├─────────────────────────────────────────────────┤
│ 通道  │ 下限校正      │ 上限校正      │ 中点校正     │
├───────┼───────────────┼───────────────┼──────────────┤
│ AI1   │ [0]           │ [4095]        │ [2048]       │
│ AI2   │ [0]           │ [4095]        │ [2048]       │
│ AI3   │ [0]           │ [4095]        │ [2048]       │
│ AI4   │ [0]           │ [4095]        │ [2048]       │
│ AI5   │ [0]           │ [4095]        │ [2048]       │
│ AI6   │ [0]           │ [4095]        │ [2048]       │
│ AI7   │ [0]           │ [4095]        │ [2048]       │
│ AI8   │ [0]           │ [4095]        │ [2048]       │
└─────────────────────────────────────────────────┘
```

#### 3.10.4 校正向导流程

点击"开始校正向导"时:

```
┌─ 通道校正向导 ──────────────────────────────┐
│ 当前: AI1通道                                │
│ 步骤1/3: 下限校正                            │
├──────────────────────────────────────────────┤
│ 1. 将AI1输入信号调整至最小值                 │
│ 2. 等待读数稳定                              │
│ 3. 当前读数: 12 (原始ADC值)                  │
│                                              │
│ [采集下限]  [跳过]  [取消]                   │
└──────────────────────────────────────────────┘

→ 点击[采集下限]后自动进入步骤2/3(上限校正)
→ 点击[采集上限]后自动进入步骤3/3(中点校正)
→ 完成后自动写入寄存器并提示成功
```

#### 3.10.5 线圈地址映射

校正操作需配合线圈写命令(0x05):

- **下限校正线圈**: 0x1000-0x100F (AI1-AI8)
- **上限校正线圈**: 0x1010-0x101F (AI1-AI8)
- **中点校正线圈**: 0x1020-0x102F (AI1-AI8)

```python
# 下限校正示例
async def calibrate_ai_lower(channel_index):
    """AI通道下限校正"""
    # 1. 发送下限校正线圈命令
    coil_addr = 0x1000 + channel_index
    await websocket.send({
        "type": "control_cmd",
        "cmd": "write_coil",
        "cmd_param": {
            "coil_addr": hex(coil_addr),
            "value": 1
        }
    })
    
    # 2. 等待控制板自动采集并写入0x2100+channel_index寄存器
    # 3. 读取校正后的值并更新界面
```

------

### 3.11 设置菜单功能

#### 3.11.1 串口配置对话框

点击`设置 → 串口配置`时弹出:

```
┌─ 串口设置 ──────────────────────────────┐
│ 选择串口: ● HMI串口  ○ PSCADA串口      │
├─────────────────────────────────────────┤
│ 端口号: [COM1▼]                         │
│ 波特率: [9600▼]                         │
│ 数据位: [8▼]                            │
│ 停止位: [1▼]                            │
│ 校验位: [无▼]                           │
│ 从站地址: [0x10]                        │
├─────────────────────────────────────────┤
│ [测试连接]  [保存]  [取消]              │
└─────────────────────────────────────────┘
```

#### 3.11.2 采集设置对话框

点击`设置 → 采集设置`时弹出:

```
┌─ 数据采集配置 ──────────────────────────┐
│ 轮询间隔: [1.0]秒  (范围:0.5-10.0)      │
│ 数据上传频率: [5]秒/次                   │
│ 数据保存周期: [12]个月                   │
│ [应用]  [恢复默认]  [取消]              │
└─────────────────────────────────────────┘
```

#### 3.11.3 关于对话框

点击`设置 → 关于`时弹出:

```
┌─ 系统信息 ──────────────────────────────┐
│ 设备ID: HYP_RPLD_001                    │
│ 设备名称: 红岩坪站钢轨电位限制装置       │
│ 系统版本: 1.0.0                         │
│ 运行时间: 72小时35分钟                   │
│ CPU使用率: 35%                          │
│ 内存使用: 1.2GB / 4.0GB                 │
│ 数据库大小: 256MB                       │
│ [关闭]                                  │
└─────────────────────────────────────────┘
```

------

## 4. 通用组件设计

### 4.1 虚拟数字键盘

#### 4.1.1 触发场景

- 点击任何数值输入框时自动弹出

#### 4.1.2 布局设计

```
┌─ 数值输入 ──────────────────┐
│ 当前值: [123.45]            │
├─────────────────────────────┤
│ [7] [8] [9]      [退格]     │
│ [4] [5] [6]      [清空]     │
│ [1] [2] [3]      [±]        │
│ [0] [.] [确定]   [取消]     │
└─────────────────────────────┘
```

#### 4.1.3 输入规则

- 整数输入:禁用小数点按钮
- 小数输入:限制小数点只能输入一次
- 负数输入:点击[±]切换正负
- 最大长度:10位数字

### 4.2 串口设置对话框

#### 4.2.1 触发方式

- 顶部菜单: 设置 → 串口配置

#### 4.2.2 对话框内容

```
┌─ 串口设置 ──────────────────────────────┐
│ 选择串口: ● HMI串口  ○ PSCADA串口      │
├─────────────────────────────────────────┤
│ 端口号: [COM1▼]                         │
│ 波特率: [9600▼]                         │
│ 数据位: [8▼]                            │
│ 停止位: [1▼]                            │
│ 校验位: [无▼]                           │
│ 从站地址: [0x10]                        │
├─────────────────────────────────────────┤
│ [测试连接]  [保存]  [取消]              │
└─────────────────────────────────────────┘
```

### 4.3 确认对话框

#### 4.3.1 使用场景

- 清除故障录波记录
- 修改重要参数
- 用户登出

#### 4.3.2 样式

```
┌─ 确认操作 ──────────────────────────────┐
│ ⚠️ 警告                                  │
│                                         │
│ 您确定要清除所有故障录波记录吗?          │
│ 此操作不可恢复!                          │
│                                         │
│ [确定]  [取消]                          │
└─────────────────────────────────────────┘
```

### 4.4 加载指示器

#### 4.4.1 样式

```
┌───────────────────────┐
│  ⏳ 正在加载数据...   │
└───────────────────────┘
```

#### 4.4.2 使用场景

- API请求等待
- 串口命令执行中
- 数据库查询中

------

## 5. 数据交互协议

### 5.1 WebSocket消息处理

#### 5.1.1 前端订阅消息类型

```python
websocket_handlers = {
    'system_status': on_system_status,
    'switch_io': on_switch_io,
    'analog_data': on_analog_data,
    'fault': on_fault,
    'control_ack': on_control_ack,
    'param_read_ack': on_param_read_ack,
    'fault_record_progress': on_fault_record_progress,
    'connection_lost': on_connection_lost,
}
```

#### 5.1.2 消息处理示例

```python
def on_analog_data(message):
    """处理模拟量数据推送"""
    for item in message['data']:
        # 更新主接线图
        if current_page == '主接线图':
            update_main_diagram_widget(item['name'], item['physical_value'])
        
        # 更新实时曲线
        if current_page == '实时曲线':
            append_to_curve_buffer(item['name'], item['physical_value'])
        
        # 更新顶部状态栏
        update_status_bar(item['name'], item['physical_value'])
```

### 5.2 API请求封装

#### 5.2.1 通用请求函数

```python
async def api_request(method, endpoint, params=None, data=None):
    """统一API请求函数"""
    headers = {"Authorization": f"Bearer {current_token}"}
    
    try:
        response = await http_client.request(
            method=method,
            url=f"{API_BASE_URL}{endpoint}",
            params=params,
            json=data,
            headers=headers,
            timeout=10.0
        )
        
        if response.status_code == 401:
            # Token过期,跳转登录页
            navigate_to_login()
            return None
        
        return response.json()
    
    except Exception as e:
        show_error(f"请求失败: {str(e)}")
        return None
```

------

## 6. 用户权限管理

### 6.1 权限类型定义

| 权限类型  | 可查看页面 | 可执行操作                      |
| --------- | ---------- | ------------------------------- |
| view_only | 全部       | 仅查看,不可下发指令             |
| control   | 全部       | 查看+下发控制指令(不含参数修改) |
| admin     | 全部       | 查看+控制+参数设置+用户管理     |

### 6.2 登录界面

```
┌─ 用户登录 ──────────────────────────────┐
│                                         │
│  [🔒 钢轨电位限制柜人机界面]            │
│                                         │
│  用户名: [___________________]          │
│  密码:   [___________________]          │
│                                         │
│  ☐ 记住密码                             │
│                                         │
│  [登录]  [忘记密码?]                    │
│                                         │
│  设备ID: HYP_RPLD_001                   │
└─────────────────────────────────────────┘
```

### 6.3 权限校验流程

```python
def check_permission(required_permission):
    """装饰器:检查用户权限"""
    def decorator(func):
        async def wrapper(*args, **kwargs):
            if not current_user:
                navigate_to_login()
                return
            
            if current_user.permission_type not in required_permission:
                show_error("权限不足,无法执行此操作")
                return
            
            return await func(*args, **kwargs)
        return wrapper
    return decorator

# 使用示例
@check_permission(['control', 'admin'])
async def send_control_command(cmd):
    # 下发控制指令
    pass
```

------

## 7. 错误处理与提示

### 7.1 错误提示样式

| 类型 | 图标 | 颜色 | 示例                          |
| ---- | ---- | ---- | ----------------------------- |
| 成功 | ✓    | 绿色 | "参数设置成功"                |
| 警告 | ⚠️    | 黄色 | "串口连接不稳定"              |
| 错误 | ✗    | 红色 | "数据查询失败:数据库连接超时" |
| 信息 | ℹ️    | 蓝色 | "正在连接服务器..."           |

### 7.2 常见错误处理

```python
error_handlers = {
    401: lambda: show_error("登录已过期,请重新登录") and navigate_to_login(),
    403: lambda: show_error("权限不足"),
    404: lambda: show_error("请求的资源不存在"),
    409: lambda: show_error("操作冲突:高优先级指令正在执行"),
    500: lambda: show_error("服务器内部错误"),
    503: lambda: show_error("服务暂时不可用,请稍后重试"),
}
```

------

## 8. 性能优化建议

### 8.1 前端优化

- **虚拟滚动**: 表格数据超过100行时启用虚拟滚动
- **防抖节流**: 实时曲线更新使用节流(100ms)
- **懒加载**: 历史曲线查询结果分批渲染

### 8.2 WebSocket优化

- **增量更新**: 仅推送变化的数据点
- **数据压缩**: 大数据量(如故障录波)使用gzip压缩
- **心跳优化**: 心跳包附带关键状态摘要,减少额外查询

### 8.3 本地缓存

```python
# 缓存配置参数,减少重复读取
config_cache = {
    'expiry': 300,  # 5分钟过期
    'data': {}
}

# 缓存历史查询结果
query_cache = LRUCache(maxsize=20)
```

------

## 9. 测试用例

### 9.1 功能测试清单

- [ ] 主接线图实时更新(模拟量/开关量)
- [ ] 系统状态页面点位颜色正确显示
- [ ] 事件记录查询分页功能
- [ ] 实时曲线2分钟滚动显示
- [ ] 历史曲线查询并导出CSV
- [ ] 控制参数读取/写入
- [ ] 故障录波查询进度显示
- [ ] API状态监控实时更新
- [ ] 用户登录/权限校验
- [ ] 串口设置保存并生效

### 9.2 异常测试

- [ ] 串口断开时页面提示
- [ ] WebSocket断开自动重连
- [ ] Token过期自动跳转登录
- [ ] 参数输入超出范围提示
- [ ] 故障录波查询中途取消
- [ ] 网络超时错误处理

------

## 10. 附录

### 10.1 配色方案

详见color_scheme_demo.html文件示例

| 用途   | 颜色值  | 示例              |
| ------ | ------- | ----------------- |
| 主色调 | #2C3E50 | 顶部栏背景        |
| 强调色 | #3498DB | 按钮/链接         |
| 成功色 | #27AE60 | 成功提示/正常状态 |
| 警告色 | #F39C12 | 警告提示          |
| 错误色 | #E74C3C | 错误提示/故障状态 |
| 背景色 | #ECF0F1 | 页面背景          |

### 10.2 图标库

- 使用Material Icons或Font Awesome
- 统一图标大小:24px

### 10.3 响应式设计

- 最小分辨率:800x600
- 推荐分辨率:1024x768
- 支持全屏模式

------

**文档版本**: v1.0
 **更新日期**: 2025-10-01
 **编制人**: 系统需求团队