# WebSocket 需求补充说明

## 1. 功能需求

### 1.1 实时数据推送

- **推送内容**：需覆盖下位机控制板全量实时数据，包括但不限于模拟量（电流、电压等，精确到小数点后 1 位）、开关量（输入 / 输出状态，用 “ON/OFF” 或 “1/0” 标识）、设备运行状态（工作 / 测试 / 故障 / 报警，附带故障代码）、通信链路状态（控制板 / PSCADA / 系统服务器连接状态）。

- **推送频率**：与工控机对控制板的轮询间隔保持一致（默认 1s，可随轮询间隔配置同步调整），确保前端数据与硬件状态无延迟同步。

  ```json
  {  
      "push_strategy": {    
          "mode": "change_driven",  *// 仅推送变化的数据（减少带宽）*    
          "full_snapshot_interval": 30,  *// 每30s推送一次全量快照（防止前端数据丢失）*    
          "heartbeat_includes_summary": true  *// 心跳包附带关键状态摘要*  
      } 
  }
  ```

### 1.2 控制指令传输

- **指令接收**：支持接收本地前端下发的全量控制指令，包括设备启停（“START/STOP”）、参数配置（“SET_TEMP_THRESHOLD:32”“SET_POLL_INTERVAL:2”）、故障复位（“RESET_ERROR:E001”）等，指令格式需与工控机后端解析规则一致（默认 JSON 格式）。
- **指令反馈**：指令传输后，需在 500ms 内向前端推送执行结果，结果包含 “指令 ID”“执行状态”（SUCCESS/FAIL）、“执行时间戳”（毫秒级）、“失败原因”（如 “DEVICE_OFFLINE”“INVALID_PARAM”），确保操作员实时知晓指令执行情况。
- **指令优先级适配**：遵循系统整体指令优先级规则（系统服务器指令＞PSCADA 指令＞本地前端指令），当 WebSocket 接收到前端指令时，需先校验是否存在高优先级指令冲突，若存在则推送 “CONFLICT_HIGH_PRIORITY” 提示，避免指令执行混乱。

### 1.3 连接状态管理

- **连接建立**：前端发起 WebSocket 连接请求时，需携带 “设备 ID”，工控机后端校验通过后建立连接，同时向前端推送 “CONNECT_SUCCESS” 确认消息，包含当前连接唯一标识（Connection ID）；校验失败（如设备 ID 不存在、未授权）则返回 “CONNECT_FAIL” 及失败原因。

- **连接保活**：采用 “心跳包” 机制维持连接，前端每10s 发送 1 次心跳请求（“HEARTBEAT”），后端需在 100ms 内返回心跳响应（“HEARTBEAT_ACK”）；若后端连续 3 次未收到心跳请求，或前端连续 3 次未收到心跳响应，自动触发连接断开流程，并推送 “CONNECTION_LOST” 告警。

- **断开重连**：当连接异常断开（如网络波动、工控机重启），前端需自动发起重连（重试间隔 5s，最多重试 10 次），重连成功后，后端需补推断开期间的关键数据（如设备状态变更、故障报警），确保前端数据不丢失；若重试 10 次仍失败，前端显示 “RECONNECT_FAILED” 并提示检查网络。

  ```python
  # 重连后数据补传逻辑（伪代码）
  async def reconnect_and_sync():
      # 1. 重连服务器
      await connect_to_server()
      
  # 2. 查询未上传数据
  failed_records = query("SELECT * FROM status_history WHERE upload_status IN (0,2) ORDER BY timestamp")
  
  # 3. 分批补传（每批100条，避免长时间阻塞）
  for batch in split_into_batches(failed_records, 100):
      success = await upload_batch(batch)
      if success:
          update("UPDATE status_history SET upload_status=1, upload_time=NOW() WHERE id IN (...)")
      else:
          break  # 补传失败则停止，等待下次重连
  
  # 4. 恢复实时上传
  resume_realtime_upload()
  ```

## 2. 性能需求

### 2.1 传输延迟

- 端到端延迟（控制板数据上传至工控机→WebSocket 推送到前端）≤100ms，其中 WebSocket 协议层延迟（数据从工控机后端到前端）≤30ms，确保实时监控场景下的操作及时性。
- 指令传输延迟（前端下发指令→WebSocket 传输至工控机后端）≤50ms，避免因延迟导致的设备操作卡顿。

### 2.2 数据完整性

- 推送数据需携带 “数据序列号”（从 1 开始自增），前端接收后校验序列号连续性，若发现序列号缺失（如从 10 直接跳至 12），需立即发送 “DATA_LOST” 请求，后端收到请求后 1s 内补推缺失数据，确保数据无断档。
- 指令传输采用 “请求 - 确认” 机制，前端下发指令后若 500ms 内未收到执行结果，自动重发 1 次指令（携带原指令 ID），避免因网络丢包导致指令未执行；重发后仍无响应则提示 “COMMAND_NO_RESPONSE”。

## 3. 可靠性需求

### 3.1 异常处理

- **数据解析异常**：若前端发送的指令格式错误（如 JSON 语法错误、参数缺失），后端需立即返回 “INVALID_COMMAND_FORMAT” 及错误详情（如 “Missing 'param' field”），且不影响其他正常连接的通信。
- **连接中断数据缓存**：工控机后端需缓存 WebSocket 连接断开前 5 分钟的关键数据（设备状态、故障信息），重连成功后优先补推缓存数据；缓存采用内存 + 本地临时文件双备份，避免工控机临时断电导致缓存丢失。
- **容错机制**：当 WebSocket 服务因异常（如端口占用、线程崩溃）停止时，工控机后端需自动重启 WebSocket 服务（重启时间≤3s），重启后自动恢复所有历史连接（基于连接标识匹配），并向前端推送 “SERVICE_RESTARTED” 通知。

### 3.2 日志记录

- 需记录 WebSocket 全生命周期日志，包括 “连接建立 / 断开时间”“连接标识”、“推送数据量”“指令收发记录”“异常事件（如连接超时、数据丢失、重连失败）”，日志格式需与系统整体日志规范一致（包含时间戳、模块标识 “WebSocket”、日志级别），日志保留≥30 天，支持按连接标识、时间范围查询。

## 4. 安全性需求

### 4.1 连接认证

- 可选启用 WebSocket 连接认证机制，前端发起连接时需携带 “用户名 + 密码哈希”（采用 SHA-256 加密）或 “临时 Token”（由系统服务器生成，有效期 1 小时），后端校验通过后方可建立连接；未认证或认证失败的连接请求，直接拒绝并记录 “UNAUTHORIZED_CONNECT_ATTEMPT” 日志，防止未授权访问。
- 使用JWT，有效期1小时
- 前端登录后获取Token 
- Token失效自动跳转登录页 
- 记录所有认证失败事件到event_records表

### 4.2 数据防篡改

- WebSocket 传输的数据（尤其是控制指令、设备参数）需携带 “数据校验码”（基于数据内容 + 固定密钥生成的 MD5 值），后端接收指令时校验校验码，若不一致则判定为数据篡改，拒绝执行指令并推送 “DATA_TAMPERED” 告警；前端接收推送数据时也需校验校验码，确保数据完整性。

## 5. 兼容性需求

### 5.1 浏览器兼容性

- 支持主流工业控制场景常用浏览器，包括 Chrome（≥90 版本）、Edge（≥90 版本）、Firefox（≥88 版本），确保在不同浏览器下 WebSocket 连接稳定性、数据推送及时性一致，无兼容性报错（如协议握手失败、数据解析异常）。

### 5.2 协议适配

- 采用标准 WebSocket 协议（RFC 6455），支持 “ws://”（非加密）和 “wss://”（加密，基于 TLS 1.2/1.3）两种连接方式，加密方式可通过工控机配置开关启用；后端需兼容前端的协议版本协商，确保不同版本浏览器均可正常建立连接。

### 5.3 数据格式兼容

- 默认采用 JSON 格式传输数据（键名需与系统数据字典一致，如 “temperature”“pressure”“device_status”）。