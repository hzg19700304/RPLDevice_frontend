> 说明：当前前端版本不包含串口通信功能。本文件仅作为协议背景资料保留，前端不实现串口。

# 串口通信相关需求补充说明

- **串口通信分为两个部分：HMI串口通信、PSCADA串口通信。**
- **HMI通信是工控机作为主站，控制板作为从站；**
- **PSCADA串口通信是工控机作为从站，PSCADA作为主站。**
- **拟采用pyserial + pymodbus模块配合编程**

#### **功能模块**

- **HMI串口通信管理**
  - 串口初始化、连接与关闭
  - 串口读（功能码：0x03/0x04）
  - 串口写（功能码：0x05/0x06/0x10）
  - 串口轮询
  - 串口命令队列处理
  - 接收数据解析（见下面附件一串口通讯协议）
- **SCADA串口通信管理**
  - 串口初始化、连接与关闭
  - 串口读（功能码：0x03/0x04）
  - 串口写（功能码：0x05/0x06/0x10）
  - 串口监听
  - 返回数据构建（见下面附件二 综合自动化通讯协议说明）
- **HMI故障录波数据读取**（见附件一第三大点：三、故障录波记录读取）
  1. **分批传输**: 每批10条记录，避免长时间占用串口
  2. **进度显示**: 实时显示查询进度和剩余时间
  3. **可取消操作**: 用户可以随时取消长时间的查询操作
  4. **异步处理**: 使用后台线程，不阻塞用户界面
  5. **错误恢复**: 单条记录失败不影响整体查询
  6. **超时控制**: 每条记录5秒超时，避免无限等待
  7. **传输间隔**: 记录间添加100ms延迟，避免串口拥塞
- **配置文件解析**（见config.ini配置文件）



 

###  附件一

### 杂散电流治理系统钢轨电位限制柜MODBUS通讯协议（工控机与主控板）

#### 一、 COM通讯协议

- **协议标准**： 通讯协议采用MODBUS RTU协议
- **波特率：** 9600
- **数据位：** 8
- **从机地址：**默认0x10（人机界面可设置）
- **停止位：**1
- **奇偶校验位：**无



#### 二、MODBUS RTU协议桢格式说明

**1、读多个保存寄存器命令（命令代码0x03H）**

读多个寄存器命令可一次读取一个或多个寄存器的值，**寄存器地址参见《表1 字寄存器地址表》**。

主机发送寄存器读命令桢，桢格式如下：

| 从机地址 | 读命令代码(03H) | 起始地址                         | 寄存器数量（N） | CRC校验码              |
| -------- | --------------- | -------------------------------- | --------------- | ---------------------- |
| 0x10     | 0x03            | 高字节在前、低字节在后（0x0001） | 0x10            | 低字节在前、高字节在后 |

其中，寄存器长度N取值为：![img](file:///C:\Users\HP\AppData\Local\Temp\ksohtml19528\wps1.png)，因此寄存器数量的高位始终等于0。

正常时，从机回复：

| 从机地址 | 功能码(0x03H) | 字节数（2xN）                           | 数据                   | CRC校验码            |
| -------- | ------------- | --------------------------------------- | ---------------------- | -------------------- |
| 0x10     | 0x03          | （2xN）个字节（高字节在前，低字节在后） | 高字节在前、低字节在后 | 低字节在前高字节在后 |

异常时，从机回复：

| 从机地址 | 错误码(0x83H) | 异常码 | CRC校验码        |
| -------- | ------------- | ------ | ---------------- |
| 0x10     | 0x83          | 0x01   | 低位在前高位在后 |

- 异常码指出了本次通讯的错误类型，异常码的含义如下：
- 01H：MDB_ERR_INVALIDCODE，寄存器读命令桢无效；
- 02H: MDB_ERR_INVALIDADDR，非法寄存器地址。

**2、写多个保持寄存器写命令 （命令代码0x10H）**

多个保持寄存器写命令主要用于批量修改设备参数功能，**寄存器地址参见《表1 字寄存器地址表》**。

主机发送寄存器写命令桢，桢格式如下：

| 从机地址 | 写命令代码(0x10H) | 起始地址 | 寄存器数量（N） | 字节数（2xN） | 2xN个字节              | CRC校验码            |
| -------- | ----------------- | -------- | --------------- | ------------- | ---------------------- | -------------------- |
| 0x10     | 0x10              | 0x0000   | 0x0001          |               | 高字节在前，低字节在后 | 低字节在前高字节在后 |

其中，寄存器长度N取值为：![img](file:///C:\Users\HP\AppData\Local\Temp\ksohtml19528\wps2.png)，因此寄存器数量的高位始终等于0。

正常时，从机回复：

| 从机地址 | 功能码(0x10H) | 起始地址 | 寄存器数量（N） | CRC校验码            |
| -------- | ------------- | -------- | --------------- | -------------------- |
| 0x10     | 0x10          | 0x0000   | 0x0001          | 低字节在前高字节在后 |

 异常时，从机回复：

| 从机地址 | 错误码(0x90H) | 异常码 | CRC校验码            |
| -------- | ------------- | ------ | -------------------- |
| 0x10     | 0x90          | 0x01   | 低字节在前高字节在后 |

-  异常码指出了本次通讯的错误类型，异常码的含义如下：
- 0x01H：MDB_ERR_INVALIDCODE，寄存器写命令桢无效；
- 0x02H: MDB_ERR_INVALIDADDR，非法写寄存器地址。

**3、单个保持寄存器写命令 （命令代码0x06H）**

单个保持寄存器写命令可对寄存器表中可读可写的任意一个参数寄存器进行修改。主要用于模拟量通道校正

主机发送命令桢格式如下：

| 从机地址 | 写命令代码(0x06H) | 寄存器地址 | 数据                         | CRC校验码            |
| -------- | ----------------- | ---------- | ---------------------------- | -------------------- |
| 0x10     | 0x06              | 0x2100     | 0x0012高字节在前，低字节在后 | 低字节在前高字节在后 |

正常时，从机回复：

| 从机地址 | 写命令代码(0x06H) | 寄存器地址 | 数据                         | CRC校验码            |
| -------- | ----------------- | ---------- | ---------------------------- | -------------------- |
| 0x10     | 0x06              | 0x2100     | 0x0012高字节在前，低字节在后 | 低字节在前高字节在后 |

异常时，从机回复：

| 从机地址 | 错误码(0x86H) | 异常码 | CRC校验码            |
| -------- | ------------- | ------ | -------------------- |
| 0x10     | 0x86          |        | 低字节在前高字节在后 |

**4、单个线圈写命令 （命令代码0x05H）**

单个线圈写命令可对**表2** **位寄存器地址表**中的任意一个逻辑位寄存器进行修改，**寄存器地址参见《表2 位寄存器地址表》**

主机命令桢格式如下：

| 从机地址 | 写命令代码(0x05H) | 寄存器地址 | 数据                         | CRC校验码            |
| -------- | ----------------- | ---------- | ---------------------------- | -------------------- |
| 0x10     | 0x05              | 0x0101     | 0x0001高字节在前，低字节在后 | 低字节在前高字节在后 |

正常时，从机回复：

| 从机地址 | 写命令代码(05H) | 寄存器地址 | 数据                         | CRC校验码            |
| -------- | --------------- | ---------- | ---------------------------- | -------------------- |
| 0x10     | 0x05            | 0x0101     | 0x0001高字节在前，低字节在后 | 低字节在前高字节在后 |

异常时，从机回复：

| 从机地址 | 错误码(85H) | 异常码 | CRC校验码            |
| -------- | ----------- | ------ | -------------------- |
| 0x10     | 0x85        |        | 低字节在前高字节在后 |



**表1** **字寄存器地址表**

| **序号**                | **寄存器地址**         | **数据类型** | **变量名**                      | **备注**                                                     |
| ----------------------- | ---------------------- | ------------ | ------------------------------- | ------------------------------------------------------------ |
| **A） 遥信**            | **读写权限：只读**     |              |                                 |                                                              |
| 1                       | 0x0000                 | Uint16       | 系统状态字                      | Bit0: 保留<br />Bit1: 保留<br />Bit2: 保留<br />Bit3: 保留<br />Bit4: 保留<br />Bit5: 故障状态；1=故障，0=正常<br />Bit6: 保留<br />Bit7: 保留； <br />Bit8: 参数正确；1=正确，0=错误<br />Bit9: KM闭锁；1=闭锁，0=正常<br />Bit10: 存储器正常；1=正常，0=错误<br />Bit11: 保留<br />Bit12: 保留<br />Bit13: 保留<br />Bit14: 保留<br />Bit15: 保留; |
| 2                       | 0x0001                 | Uint16       | IGBT驱动返回信号                | Bit0:保留<br />Bit1:保留<br />Bit2:保留<br />Bit3:保留<br />Bit4:保留<br />Bit5:保留<br />Bit6:保留<br />Bit7:保留<br />Bit8:保留<br />Bit9:保留<br />Bit10:保留<br />Bit11:保留<br />Bit12:保留<br />Bit13:保留<br />Bit14:保留<br />Bit15:保留 |
| 3                       | 0x0002                 | Uint16       | 开关量输入                      | Bit0:  隔离开关QS位置<br />Bit1:  熔断器1位置<br />Bit2:  熔断器2位置<br />Bit3:  熔断器3位置<br />Bit4:  熔断器4位置<br />Bit5:  熔断器5位置<br />Bit6:  熔断器6位置<br />Bit7:  保留<br />Bit8:  SB1按钮合位<br />Bit9:  SB1按钮分位<br />Bit10: 温度开关S1_60℃,电阻器温度<br />Bit11: 温度开关S2_100℃,电阻器温度<br />Bit12: 温度开关S3_60℃,斩波组件温度<br />Bit13: 温度开关S4_90℃,斩波组件温度<br />Bit14:  保留<br />Bit15:  保留 |
| 4                       | 0x0003                 | Uint16       | 开关量输出                      | Bit0:  保留<br />Bit1:  保留<br />Bit2:  保留<br />Bit3:  保留<br />Bit4:  保留<br />Bit5:  保留<br />Bit6:  斩波组件风机控制<br />Bit7:  电阻器风机控制<br />Bit8:  设备故障灯<br />Bit9:  保留<br />Bit10:  保留<br />Bit11:  保留<br />Bit12:  保留<br />Bit13:  保留<br />Bit14:  保留<br />Bit15:  保留 |
| 5                       | 0x0004                 | Uint16       | 故障信息字                      | Bit0: 1段电压保护；1=故障，0=正常<br />Bit1: 2段电压保护；1=故障，0=正常<br />Bit2: 3段电压保护；1=故障，0=正常<br />Bit3: 4段电压保护；1=故障，0=正常<br />Bit4: 5段电压保护；1=故障，0=正常<br />Bit5: 6段电压保护；1=故障，0=正常<br />Bit6: 7段电压保护；1=故障，0=正常<br />Bit7: 8段电压保护；1=故障，0=正常<br />Bit8: 9段电压保护；1=故障，0=正常<br />Bit9: 10段电压保护；1=故障，0=正常<br />Bit10: 晶闸管动作；1=故障，0=正常<br />Bit11: 接触器故障；1=故障，0=正常<br />Bit12: 主控板故障；1=故障，0=正常<br />Bit13: 保留<br />Bit14: 保留<br />Bit15: 保留 |
| **B）遥测**             | **读写权限：只读**     |              |                                 |                                                              |
| 6                       | 0x0005                 | Uint16       | 轨电位绝对值最大值              | 高位在前，低位在后                                           |
| 7                       | 0x0006                 | Int          | 最大极化电位                    | 高位在前，低位在后                                           |
| 8                       | 0x0007                 | Int          | 工作模式                        | 0：自动排流<br />1：手动关闭排流<br />2：手动开启排流<br />3：遥控关闭排流<br />4：遥控开启排流 |
| 9                       | 0x0008                 | Int          | 支路1电流                       | 高位在前，低位在后                                           |
| 10                      | 0x0009                 | Int          | 支路2电流                       | 高位在前，低位在后                                           |
| 11                      | 0x000A                 | Int          | 支路3电流                       | 高位在前，低位在后                                           |
| 12                      | 0x000B                 | Int          | 支路4电流                       | 高位在前，低位在后                                           |
| 13                      | 0x000C                 | Int          | 支路5电流                       | 高位在前，低位在后                                           |
| 14                      | 0x000D                 | Int          | 支路6电流                       | 高位在前，低位在后                                           |
| 15                      | 0x000E                 | Int          | 支路电压1                       | 高位在前，低位在后                                           |
| 16                      | 0x000F                 | Int          | 支路电压2                       | 高位在前，低位在后                                           |
| 17                      | 0x0010                 | Int          | 保留                            | 高位在前，低位在后                                           |
| 18                      | 0x0011                 | Int          | 保留                            | 高位在前，低位在后                                           |
| 19                      | 0x0012                 | Int          | 保留                            | 高位在前，低位在后                                           |
| 20                      | 0x0013                 | Int          | 保留                            | 高位在前，低位在后                                           |
| 21                      | 0x0014                 | Int          | 邻站1钢轨电位                   | 高位在前，低位在后                                           |
| 。。。                  | 。。。                 | 。。。       | 。。。                          | 。。。                                                       |
| 30                      | 0x001D                 | Int          | 邻站10钢轨电位                  | 高位在前，低位在后                                           |
| 31                      | 0x001E                 | Int          | 邻站1控制柜状态                 | 高位在前，低位在后                                           |
| 。。。                  | 。。。                 | 。。。       | 。。。                          | 。。。                                                       |
| 40                      | 0x0027                 | Int          | 邻站10控制柜状态                | 高位在前，低位在后                                           |
| 41                      | 0x0028                 | Int          | 邻站1极化电位最大平均值         | 高位在前，低位在后                                           |
| 。。。                  | 。。。                 | 。。。       | 。。。                          | 。。。                                                       |
| 50                      | 0x0031                 | Int          | 邻站10极化电位最大平均值        | 高位在前，低位在后                                           |
| **C）故障记录目录信息** | **只读**               |              |                                 |                                                              |
| 1                       | 0x0300                 | Uint16       | 当前故障录波记录数              | 高位在前，低位在后                                           |
| 2                       | 0x0301                 | Int          | 记录长度                        | 高位在前，低位在后                                           |
| 3                       | 0x0302                 | Uint16       | 保留                            | 高位在前，低位在后                                           |
| 4                       | 0x0303                 | Uint16       | 最多存放记录数                  | 高位在前，低位在后                                           |
| **D）传感器参数**       | **只读**               |              |                                 |                                                              |
| 1                       | 0x2000                 | Int          | AI1下限                         | 高位在前，低位在后                                           |
| 2                       | 0x2001                 | Int          | AI2下限                         | 高位在前，低位在后                                           |
| 3                       | 0x2002                 | Int          | AI3下限                         | 高位在前，低位在后                                           |
| 4                       | 0x2003                 | Int          | AI4下限                         | 高位在前，低位在后                                           |
| 5                       | 0x2004                 | Int          | AI5下限                         | 高位在前，低位在后                                           |
| 6                       | 0x2005                 | Int          | AI6下限                         | 高位在前，低位在后                                           |
| 7                       | 0x2006                 | Int          | AI7下限                         | 高位在前，低位在后                                           |
| 8                       | 0x2007                 | Int          | AI8下限                         | 高位在前，低位在后                                           |
| 9                       | 0x2008                 | Int          | AI1上限                         | 高位在前，低位在后                                           |
| 10                      | 0x2009                 | Int          | AI2上限                         | 高位在前，低位在后                                           |
| 11                      | 0x200A                 | Int          | AI3上限                         | 高位在前，低位在后                                           |
| 12                      | 0x200B                 | Int          | AI4上限                         | 高位在前，低位在后                                           |
| 13                      | 0x200C                 | Int          | AI5上限                         | 高位在前，低位在后                                           |
| 14                      | 0x200D                 | Int          | AI6上限                         | 高位在前，低位在后                                           |
| 15                      | 0x200E                 | Int          | AI7上限                         | 高位在前，低位在后                                           |
| 16                      | 0x200F                 | Int          | AI8上限                         | 高位在前，低位在后                                           |
| **E）AI校正值**         | **可读可写**           |              |                                 |                                                              |
| 1                       | 0x2100                 | Uint16       | AI1下限                         | 高位在前，低位在后                                           |
| 2                       | 0x2101                 | Uint16       | AI2下限                         | 高位在前，低位在后                                           |
| 3                       | 0x2102                 | Uint16       | AI3下限                         | 高位在前，低位在后                                           |
| 4                       | 0x2103                 | Uint16       | AI4下限                         | 高位在前，低位在后                                           |
| 5                       | 0x2104                 | Uint16       | AI5下限                         | 高位在前，低位在后                                           |
| 6                       | 0x2105                 | Uint16       | AI6下限                         | 高位在前，低位在后                                           |
| 7                       | 0x2106                 | Uint16       | AI7下限                         | 高位在前，低位在后                                           |
| 8                       | 0x2107                 | Uint16       | AI8下限                         | 高位在前，低位在后                                           |
| 9                       | 0x2108                 | Uint16       | AI1上限                         | 高位在前，低位在后                                           |
| 10                      | 0x2109                 | Uint16       | AI2上限                         | 高位在前，低位在后                                           |
| 11                      | 0x210A                 | Uint16       | AI3上限                         | 高位在前，低位在后                                           |
| 12                      | 0x210B                 | Uint16       | AI4上限                         | 高位在前，低位在后                                           |
| 13                      | 0x210C                 | Uint16       | AI5上限                         | 高位在前，低位在后                                           |
| 14                      | 0x210D                 | Uint16       | AI6上限                         | 高位在前，低位在后                                           |
| 15                      | 0x210E                 | Uint16       | AI7上限                         | 高位在前，低位在后                                           |
| 16                      | 0x210F                 | Uint16       | AI8上限                         | 高位在前，低位在后                                           |
| 17                      | 0x2110                 | Uint16       | AI1中点                         | 高位在前，低位在后                                           |
| 18                      | 0x2111                 | Uint16       | AI2中点                         | 高位在前，低位在后                                           |
| 19                      | 0x2112                 | Uint16       | AI3中点                         | 高位在前，低位在后                                           |
| 20                      | 0x2113                 | Uint16       | AI4中点                         | 高位在前，低位在后                                           |
| 21                      | 0x2114                 | Uint16       | AI5中点                         | 高位在前，低位在后                                           |
| 22                      | 0x2115                 | Uint16       | AI6中点                         | 高位在前，低位在后                                           |
| 23                      | 0x2116                 | Uint16       | AI7中点                         | 高位在前，低位在后                                           |
| 24                      | 0x2117                 | Uint16       | AI8中点                         | 高位在前，低位在后                                           |
| **F）控制参数**         | **可读/可写**          |              |                                 |                                                              |
| 1                       | 0x2200                 | Uint16       | 过压保护延时时间（ms）          | 高位在前，低位在后                                           |
| 2                       | 0x2201                 | Uint16       | 支路过流保护值（A）             | 高位在前，低位在后                                           |
| 3                       | 0x2202                 | Uint16       | IGBT故障延时时间（ms）          | 高位在前，低位在后                                           |
| 4                       | 0x2203                 | Uint16       | 熔断器故障延时时间（ms）        | 高位在前，低位在后                                           |
| 5                       | 0x2204                 | Uint16       | 超温延时（ms）                  | 高位在前，低位在后                                           |
| 6                       | 0x2205                 | Uint16       | 延时关闭风扇时间（ms）          | 高位在前，低位在后                                           |
| 7                       | 0x2206                 | Uint16       | 轨电位控制阈值1                 | 高位在前，低位在后                                           |
| 8                       | 0x2207                 | Uint16       | 轨电位控制阈值2                 | 高位在前，低位在后                                           |
| 9                       | 0x2208                 | Uint16       | 极化排流阈值1                   | 高位在前，低位在后                                           |
| 10                      | 0x2209                 | Uint16       | 极化排流阈值2                   | 高位在前，低位在后                                           |
| 11                      | 0x220A                 | Uint16       | 停止排流延时（ms）              | 高位在前，低位在后                                           |
| 12                      | 0x220B                 | Uint16       | 档位切换延时（ms）              | 高位在前，低位在后                                           |
| 13                      | 0x220C                 | Uint16       | 允许工作电压上限                | 高位在前，低位在后                                           |
| 14                      | 0x220D                 | Uint16       | 轨电位控制柜通讯超时时间（ms）  | 高位在前，低位在后                                           |
| 15                      | 0x220E                 | Uint16       | 临站轨电位控制柜数量            | 高位在前，低位在后                                           |
| 16                      | 0x220F                 | Int          | 临站1地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 17                      | 0x2210                 | Int          | 临站2地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 18                      | 0x2211                 | Int          | 临站3地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 19                      | 0x2212                 | Int          | 临站4地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 20                      | 0x2213                 | Int          | 临站5地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 21                      | 0x2214                 | Int          | 临站6地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 22                      | 0x2215                 | Int          | 临站7地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 23                      | 0x2216                 | Int          | 临站8地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 24                      | 0x2217                 | Int          | 临站9地址：0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 25                      | 0x2218                 | Int          | 临站10地址:0-32，-1表示没有使用 | 高位在前，低位在后                                           |
| 26                      | 0x2219                 | Uin16        | 故障录波故障后长度              | 高位在前，低位在后                                           |
| 27                      | 0x221A                 | Uin16        | 故障录波周期                    | 高位在前，低位在后                                           |
| **G）系统对时**         | **读写权限：可写可读** |              |                                 |                                                              |
| 1                       | 0x3000                 | Uint16       | 系统时间_毫秒                   | 高位在前，低位在后                                           |
| 2                       | 0x3001                 | Uint16       | 系统时间_秒_分                  | 高8位=秒，低8位=分                                           |
| 3                       | 0x3002                 | Uint16       | 系统时间_时_日                  | 高8位=时，低8位=日期                                         |
| 4                       | 0x3003                 | Uint16       | 系统时间_月_年                  | 高8位=月份，低8位=年低字节                                   |
| **H）极化电位信息**     | **只写**               |              |                                 |                                                              |
| 1                       | 0x0100                 | Int          | 极化电位最大值                  | 高位在前，低位在后                                           |



**表2 位寄存器地址表**

| 序号                    | 位寄存器地址       | **数据类型** | **命令名**       | **备注**                                                     |
| ----------------------- | ------------------ | ------------ | ---------------- | ------------------------------------------------------------ |
| **A）基本命令位**       | **读写权限：只写** |              |                  |                                                              |
| 1                       | 0x0101             | bit          | 故障复位命令位   | 非零：复位0x0000：不影响                                     |
| 2                       | 0x0102             | bit          | 保留             |                                                              |
| 3                       | 0x0103             | bit          | 保留             |                                                              |
| 4                       | 0x0104             | bit          | 测试             | 非零：切换到测试状态0x0000：不影响                           |
| 5                       | 0x0105             | bit          | 工作             | 非零：切换到工作状态0x0000：不影响                           |
| **B）故障录波记录清除** | **读写权限：只写** |              |                  |                                                              |
| 6                       | 0x0110             | bit          | 清除故障录波记录 | 非零：清除故障录波记录0x0000：不影响                         |
| **C）遥控排流**         | **读写权限：只写** |              |                  |                                                              |
| 7                       | 0x0120             | bit          | 遥控关闭排流     | 在没有故障，且当前模式不是本地手动模式时，<br />切换为遥控关闭排流模式，关闭所有支路排流； |
| 8                       | 0x0121             | bit          | 遥控排流模式     | 在没有故障，且当前模式不是本地手动模式时，<br />遥控排流模式，开启所有支路排流； |
| 9                       | 0x0122             | bit          | 自动排流模式     | 在没有故障，且当前模式不是本地手动模式时，切换为自动排流模式 |



#### **三、故障录波记录文件读取**

主机命令桢格式如下：

| 从机地址 | 文件读命令代码(14H) | 字节数 | 参数类型 | 文件编号                   | 记录起始编号地址           | 纪录长度N                  | CRC校验码                  |
| -------- | ------------------- | ------ | -------- | -------------------------- | -------------------------- | -------------------------- | -------------------------- |
| 0x10     | 0x14                | 0x07   | 0x06     | 高字节在前<br />低字节在后 | 高字节在前<br />低字节在后 | 高字节在前<br />低字节在后 | 高字节在前<br />低字节在后 |

 采用该协议进行故障录波读取方法：

1） 将故障录波记录当成文件来进行处理，每个故障录波看成一个文件，每个寄存器看成一条记录；

2） 文件编号：为故障录波编号，取值范围为0~故障录波记录数-1，0：表示最近一条记录，1表示上一条记录，2表示上上条记录，依次类推；

3） 记录起始编号地址：为读取记录寄存器的起始偏移位置；

4） 记录长度：为读取记录寄存器的寄存数值，长度不能超过125；

5） 由于故障记录长度超过64，因而应该分割成多块进行读取



**表3 故障录波记录寄存器定义**

| 序号                                        | 偏移地址 | 数据类型 | 变量名称              | 备注                                                         |
| ------------------------------------------- | -------- | -------- | --------------------- | ------------------------------------------------------------ |
| 1                                           | 0        | Uint16   | 故障发生时刻_故障信息 | Bit0: 支路1过流保护<br />Bit1: 支路2过流保护<br />Bit2: 支路3过流保护<br />Bit3: 支路4过流保护<br />Bit4: 支路5过流保护<br />Bit5: 支路6过流保护<br />Bit6: 电阻超温报警<br />Bit7: 熔断器跳闸<br />Bit8: IGBT1故障<br />Bit9: IGBT2故障<br />Bit10: IGBT3故障<br />Bit11: IGBT4故障<br />Bit12: IGBT5故障<br />Bit13: IGBT6故障<br />Bit14: IGBT超温故障<br />Bit15：铁电存储器故障 |
| 2                                           | 1        | Uint16   | 故障发生时刻_毫秒     | 高位在前，低位在后                                           |
| 3                                           | 2        | Uint16   | 故障发生时时刻_秒分   | 高8位=秒，低8位=分                                           |
| 4                                           | 3        | Uint16   | 故障发生时时刻_时日   | 高8位=时，低8位=日期                                         |
| 5                                           | 4        | Uint16   | 故障发生时时刻_月年   | 高8位=月份，低8位=年低字节                                   |
| 6                                           | 5        | Uint16   | 故障点位置            |                                                              |
| 7                                           | 6        | Uint16   | 故障录波周期(ms)      |                                                              |
| 故障记录第1点数据（故障发生时刻最前点数据） |          |          |                       |                                                              |
|                                             | 7        | Uint16   | 系统状态              | Bit0: 1=测试状态；0=工作状态<br />Bit1: 0=吸收状态；1=正在吸收<br />Bit2: 故障状态；1=故障，0=正常<br />Bit3:  参数正确；1=参数正确，0=参数错误<br />Bit4: 报警标志；1=报警<br />Bit5:  轨电位控制柜1通讯超时<br />Bit6:  轨电位控制柜2通讯超时<br />Bit7:  轨电位控制柜3通讯超时<br />Bit8:  轨电位控制柜4通讯超时<br />Bit9: 轨电位控制柜5通讯超时<br />Bit10: 轨电位控制柜6通讯超时<br />Bit11: 任一邻站控制柜接触器KM2闭锁<br />Bit12: 任一邻站控制柜处于吸收状态<br />Bit13-15: 运行阶段状态<br />    0：空闲状态；    <br />    1：低档位排流    <br />    2：最高档排流    <br />    3：KM2闭锁排流    <br />    4：手动开启排流    <br />    5：手动关闭排流    <br />    7：故障自锁 |
|                                             | 8        | Uint16   | 开关量输入            | Bit0:  隔离开关QS位置<br />Bit1:  熔断器1位置<br />Bit2:  熔断器2位置<br />Bit3:  熔断器3位置<br />Bit4:  熔断器4位置<br />Bit5:  熔断器5位置<br />Bit6:  熔断器6位置<br />Bit7:  保留<br />Bit8:  SB1按钮合位<br />Bit9:  SB1按钮分位<br />Bit10: 温度开关S1_60℃,电阻器温度<br />Bit11: 温度开关S2_100℃,电阻器温度<br />Bit12: 温度开关S3_60℃,斩波组件温度<br />Bit13: 温度开关S4_90℃,斩波组件温度<br />Bit14:  保留<br />Bit15:  保留 |
|                                             | 9        | Uint16   | 开关量输出            | Bit0:  保留<br />Bit1:  保留<br />Bit2:  保留<br />Bit3:  保留<br />Bit4:  保留<br />Bit5:  保留<br />Bit6:  斩波组件风机控制<br />Bit7:  电阻器风机控制<br />Bit8:  设备故障灯<br />Bit9:  保留<br />Bit10:  保留<br />Bit11:  保留<br />Bit12:  保留<br />Bit13:  保留<br />Bit14:  保留<br />Bit15:  保留 |
|                                             | 10       | Uint16   | 轨电位绝对值最大值    | 高位在前，低位在后                                           |
|                                             | 11       | Int      | 最大极化电位          | 高位在前，低位在后                                           |
|                                             | 12       | Int      | 支路1电流             | 高位在前，低位在后                                           |
|                                             | 13       | Int      | 支路2电流             | 高位在前，低位在后                                           |
|                                             | 14       | Int      | 支路3电流             | 高位在前，低位在后                                           |
|                                             | 15       | Int      | 支路4电流             | 高位在前，低位在后                                           |
|                                             | 16       | Int      | 支路5电流             | 高位在前，低位在后                                           |
|                                             | 17       | Int      | 支路6电流             | 高位在前，低位在后                                           |
|                                             | 18       | Int      | 支路电压1             | 高位在前，低位在后                                           |
|                                             | 19       | Int      | 支路电压2             | 高位在前，低位在后                                           |
| .......                                     |          |          |                       |                                                              |
| 故障记录第i点数据（故障发生时刻i点数据）    |          |          |                       |                                                              |
|                                             | i*13+7   | Uint16   | 系统状态              | Bit0:  工作状态；1=工作状态<br />Bit1:  吸收状态；1=正在吸收<br />Bit2:  故障状态；1=故障，0=正常<br />Bit3:  参数正确；1=参数正确，0=参数错误<br />Bit4:  存储器满；1=故障录波存储器满<br />Bit5:  轨电位控制柜1通讯超时<br />Bit6:  轨电位控制柜2通讯超时<br />Bit7:  轨电位控制柜3通讯超时<br />Bit8:  轨电位控制柜4通讯超时<br />Bit9: 轨电位控制柜5通讯超时<br />Bit10: 轨电位控制柜6通讯超时<br />Bit11: 任一邻站控制柜接触器KM2闭锁<br />Bit12: 任一邻站控制柜处于吸收状态<br />Bit13-15: 运行阶段状态 |
|                                             | i*13+8   | Uint16   | 开关量输入            | Bit0:  隔离开关QS位置<br />Bit1:  熔断器1位置<br />Bit2:  熔断器2位置<br />Bit3:  熔断器3位置<br />Bit4:  熔断器4位置<br />Bit5:  熔断器5位置<br />Bit6:  熔断器6位置<br />Bit7:  保留<br />Bit8:  SB1按钮合位<br />Bit9:  SB1按钮分位<br />Bit10:  温度开关S1_60℃,电阻器环境温度<br />Bit11:  温度开关S2_100℃,电阻器环境温度<br />Bit12:  温度开关S3_60℃,斩波组件温度<br />Bit13:  温度开关S4_90℃,斩波组件温度<br />Bit14:  保留<br />Bit15:  保留 |
|                                             | i*13+9   | Uint16   | 开关量输出            | Bit0:  保留<br />Bit1:  保留<br />Bit2:  保留<br />Bit3:  保留<br />Bit4:  保留<br />Bit5:  保留<br />Bit6:  斩波组件风机控制<br />Bit7:  电阻器风机控制<br />Bit8:  设备故障灯<br />Bit9:  保留<br />Bit10:  保留<br />Bit11:  保留<br />Bit12:  保留<br />Bit13:  保留<br />Bit14:  保留<br />Bit15:  保留 |
|                                             | i*13+10  | Uint16   | 轨电位绝对值最大值    | 高位在前，低位在后                                           |
|                                             | i*13+11  | Int      | 最大极化电位          | 高位在前，低位在后                                           |
|                                             | i*13+12  | Int      | 支路1电流             | 高位在前，低位在后                                           |
|                                             | i*13+13  | Int      | 支路2电流             | 高位在前，低位在后                                           |
|                                             | i*13+14  | Int      | 支路3电流             | 高位在前，低位在后                                           |
|                                             | i*13+15  | Int      | 支路4电流             | 高位在前，低位在后                                           |
|                                             | i*13+16  | Int      | 支路5电流             | 高位在前，低位在后                                           |
|                                             | i*13+17  | Int      | 支路6电流             | 高位在前，低位在后                                           |
|                                             | i*13+18  | Int      | 支路电压1             | 高位在前，低位在后                                           |
|                                             | i*13+19  | Int      | 支路电压2             | 高位在前，低位在后                                           |
| .....总计300点数据                          |          |          |                       |                                                              |

 

 



### 附件二

### 综合自动化通讯协议说明（工控机与PSCADA）

 工控机作为从站，PSCADA作为主站

#### 一、 串口通讯协议

- **协议标准**： 通讯协议采用`MODBUS RTU`协议

- **波特率：** 9600

- **数据位：** 8

- **从机地址：**默认0x5E（人机界面可设置）

- **停止位：**1

- **奇偶校验位：**无

  

####  二、MODBUS RTU协议桢格式说明

#### 1、读多个保存寄存器命令（命令代码0x03H）

读多个寄存器命令可一次读取一个或多个寄存器的值。寄存器地址参见**《字寄存器地址 表一》**

主机发送寄存器读命令桢，桢格式如下：

| 从机地址 | 读命令代码(03H) | 起始地址                     | 寄存器数量（N） | CRC校验码              |
| -------- | --------------- | ---------------------------- | --------------- | ---------------------- |
| 0x5e     | 0x03            | 0x0000  高字节在前低字节在后 | 0x0004          | 低字节在前，高字节在后 |
| 高位     | 低位            | 高位（00H）                  | 低 位           |                        |

其中，寄存器长度N取值为：![img](file:///C:\Users\HP\AppData\Local\Temp\ksohtml19528\wps3.png)，因此寄存器数量的高位始终等于0。

正常时，从机回复：

| 从机地址 | 功能码(0x03H) | 字节数（2xN）                           | 数据                     | CRC校验码              |
| -------- | ------------- | --------------------------------------- | ------------------------ | ---------------------- |
| 0x5e     | 0x03          | （2xN）个字节（高字节在前，低字节在后） | 。。。。。。。。。。。。 | 低字节在前，高字节在后 |

异常时，从机回复：

| 从机地址 | 错误码(0x83H) | 异常码 | CRC校验码              |
| -------- | ------------- | ------ | ---------------------- |
| 0x5e     | 0x83          | 0x01   | 低字节在前，高字节在后 |

异常码指出了本次通讯的错误类型，异常码的含义如下：

- 01H：MDB_ERR_INVALIDCODE，寄存器读命令桢无效；
- 02H: MDB_ERR_INVALIDADDR，非法寄存器地址。

#### 2、多个保持寄存器写命令（命令代码0x10H）

多个保持寄存器写命令主要用于批量修改设备参数、系统对时等功能。寄存器地址参见**《字寄存器地址 表一》**

主机发送寄存器写命令桢，桢格式如下：

| 从机地址 | 写命令代码(0x10H) | 起始地址 | 寄存器数量（N） | 字节数（2xN） | 2xN个字节              | CRC校验码              |
| -------- | ----------------- | -------- | --------------- | ------------- | ---------------------- | ---------------------- |
| 0x5e     | 0x10              | 0x0000   | 0x0001          | 0x02          | 高字节在前，低字节在后 | 低字节在前，高字节在后 |

其中，寄存器长度N取值为：![img](file:///C:\Users\HP\AppData\Local\Temp\ksohtml19528\wps4.png)，因此寄存器数

量的高位始终等于0。

正常时，从机回复：

| 从机地址 | 功能码(0x10H) | 起始地址 | 寄存器数量（N） | CRC校验码              |
| -------- | ------------- | -------- | --------------- | ---------------------- |
| 0x5e     | 0x10          | 0x0000   | 0x0001          | 低字节在前，高字节在后 |

 异常时，从机回复：

| 从机地址 | 错误码(0x90H) | 异常码 | CRC校验码              |
| -------- | ------------- | ------ | ---------------------- |
| 0x5e     | 0x90H         | 0x01H  | 低字节在前，高字节在后 |

 异常码指出了本次通讯的错误类型，异常码的含义如下：

- 0x01H：MDB_ERR_INVALIDCODE，寄存器写命令桢无效；
- 0x02H: MDB_ERR_INVALIDADDR，非法写寄存器地址。

#### 3、单个线圈（逻辑量）写命令 （命令代码0x05H）

单个线圈写命令可对逻辑位寄存器表中的任意一个逻辑位寄存器进行修改，主要用于遥控命令下发，如故障复位命令。寄存器地址参见**《位寄存器地址 表二》**

主机命令桢格式如下：

| 从机地址 | 写命令代码(0x05H) | 寄存器地址 | 数据   | CRC校验码              |
| -------- | ----------------- | ---------- | ------ | ---------------------- |
| 0x5e     | 0x05              | 0x0101     | 0x0001 | 低字节在前，高字节在后 |

正常时，从机回复：

| 从机地址 | 写命令代码(0x05H) | 寄存器地址 | 数据   | CRC校验码              |
| -------- | ----------------- | ---------- | ------ | ---------------------- |
| 0x5e     | 0x05              | 0x0101     | 0x0001 | 低字节在前，高字节在后 |

异常时，从机回复：

| 从机地址 | 错误码(85H) | 异常码 | CRC校验码              |
| -------- | ----------- | ------ | ---------------------- |
| 0x5e     | 0x85        |        | 低字节在前，高字节在后 |

 

**字寄存器地址  表一**

| **序号**         | **寄存器地址**           | **数据类型** | **变量名**     | **备注**                                                     |
| ---------------- | ------------------------ | ------------ | -------------- | ------------------------------------------------------------ |
| **A）** **遥信** | **读写权限：只读**       |              |                |                                                              |
| 1                | 0x0000                   | Uint16       | 系统状态字     | Bit0: 保留<br />Bit1: 保留<br />Bit2: 保留<br />Bit3: 保留<br />Bit4: 保留<br />Bit5: 故障状态；1=故障，0=正常<br />Bit6: 保留<br />Bit7: 保留； <br />Bit8: 参数正确；1=正确，0=错误<br />Bit9: KM闭锁；1=闭锁，0=正常<br />Bit10: 存储器正常；1=正常，0=错误<br />Bit11: 保留<br />Bit12: 保留<br />Bit13: 保留<br />Bit14: 保留<br />Bit15: 保留; |
| 2                | 0x0001                   | Uint16       | 输入状态字     | Bit0: 短接接触器合位；1=合位，0=分位<br />Bit1: SB1合位；1=正常，0=熔断<br />Bit2: SB2合位；1=正常，0=熔断<br />Bit3: 保留<br />Bit4: 保留<br />Bit5: 保留<br />Bit6: 保留<br />Bit7: 保留<br />Bit8: 保留<br />Bit9: 门锁关闭；1=关闭，0=打开<br />Bit10: 保留<br />Bit11: 保留<br />Bit12: 保留<br />Bit13: 保留<br />Bit14: 保留<br />Bit15: 保留 |
| 3                | 0x0002                   | Uint16       | 输出状态字     | Bit0: K1合闸；1=合闸，0=分闸<<br />Bit1: 保留<br />Bit2: 保留<br />Bit3: 保留<br />Bit4: 保留<br />Bit5: 保留<br />Bit6: 保留<br />Bit7: 保留<br />Bit8: K9合闸；1=合闸，0=分闸<<br />Bit9: 运行指示<br />Bit10: 保留<br />Bit11: 保留<br />Bit12: 保留<br />Bit13: 保留<br />Bit14: 保留<br />Bit15: 保留 |
| 4                | 0x0003                   | Uint16       | 故障信息字1    | Bit0: 1段电压保护；1=故障，0=正常<br />Bit1: 2段电压保护；1=故障，0=正常<br />Bit2: 3段电压保护；1=故障，0=正常<br />Bit3: 4段电压保护；1=故障，0=正常<br />Bit4: 5段电压保护；1=故障，0=正常<br />Bit5: 6段电压保护；1=故障，0=正常<br />Bit6: 7段电压保护；1=故障，0=正常<br />Bit7: 8段电压保护；1=故障，0=正常<br />Bit8: 9段电压保护；1=故障，0=正常<br />Bit9: 10段电压保护；1=故障，0=正常<br />Bit10: 晶闸管动作；1=故障，0=正常<br />Bit11: 接触器故障；1=故障，0=正常<br />Bit12: IGBT5故障；1=故障，0=正常<br />Bit13: IGBT6故障；1=故障，0=正常<br />Bit14: IGBT超温；1=故障，0=正常<br />Bit15: 电抗器超温；1=故障，0=正常 |
| 5                | 0x0004                   | Uint16       | 故障信息字2    | Bit0: 保留<br />Bit1: 保留<br />Bit2: 保留<br />Bit3: 保留<br />Bit4: 保留<br />Bit5: 保留<br />Bit6: 保留<br />Bit7: 保留<br />Bit8: 保留<br />Bit9: 保留<br />Bit10: 保留<br />Bit11: 保留<br />Bit12: 保留<br />Bit13: 保留<br />Bit14: 保留<br />Bit15: 保留 |
| **B）系统对时**  | **读写权限：可写、可读** |              |                |                                                              |
| 12               | 0x3000                   | Uint16       | 系统时间_毫秒  | 高位在前，低位在后                                           |
| 13               | 0x3001                   | Uint16       | 系统时间_秒_分 | 高8位=秒，低8位=分                                           |
| 14               | 0x3002                   | Uint16       | 系统时间_时_日 | 高8位=时，低8位=日期                                         |
| 15               | 0x3003                   | Uint16       | 系统时间_月_年 | 高8位=月份，低8位=年低字节                                   |

 

 **位寄存器地址  表二**

| 序号              | 位寄存器地址       | **数据类型** | 命令名           | **备注**                       |
| ----------------- | ------------------ | ------------ | ---------------- | ------------------------------ |
| **A）操作命令位** | **读写权限：只写** |              |                  |                                |
| 1                 | 0x0101             | Uint16       | 故障复位命令位   | 非零：复位，0x0000：不影响     |
| 2                 | 0x0120             | Uint16       | 手动关闭排流     | 非零：关闭排流，0x0000：不影响 |
| 3                 | 0x0121             | Uint16       | 手动开启排流     | 非零：开启排流，0x0000：不影响 |
| 4                 | 0x0123             | Uint16       | 手动排流模式选择 | 非零：手动模式，0x0000：不影响 |
| 5                 | 0x0122             | Uint16       | 自动排流模式选择 | 非零：自动模式，0x0000：不影响 |

